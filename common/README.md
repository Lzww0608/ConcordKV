# ConcordKV Common æ¨¡å—

ConcordKV åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿçš„é€šç”¨å·¥å…·å’ŒåŸºç¡€è®¾æ–½æ¨¡å—ã€‚

## æ¦‚è¿°

æœ¬æ¨¡å—ä¸º ConcordKV ç³»ç»Ÿæä¾›æ ¸å¿ƒçš„åŸºç¡€è®¾æ–½æ”¯æŒï¼ŒåŒ…æ‹¬é…ç½®ç®¡ç†ã€é€šç”¨å·¥å…·ã€ç›‘æ§æŒ‡æ ‡å’Œæµ‹è¯•æ¡†æ¶ã€‚æ‰€æœ‰ç»„ä»¶éƒ½ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€çº¿ç¨‹å®‰å…¨å’Œæ˜“äºä½¿ç”¨çš„ç‰¹ç‚¹ã€‚

## ç›®å½•ç»“æ„

```
common/
â”œâ”€â”€ config/           - é…ç½®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ config.h/.c   - æ ¸å¿ƒé…ç½®å¼•æ“
â”‚   â””â”€â”€ Makefile      - ç¼–è¯‘é…ç½®
â”œâ”€â”€ util/             - é€šç”¨å·¥å…·æ¨¡å—  
â”‚   â”œâ”€â”€ util.h/.c     - åŸºç¡€å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ log.h/.c      - æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ network.h/.c  - ç½‘ç»œå·¥å…·
â”‚   â”œâ”€â”€ network_io.c  - ç½‘ç»œIOæ‰©å±•
â”‚   â”œâ”€â”€ timer.h/.c    - å®šæ—¶å™¨
â”‚   â”œâ”€â”€ crypt.h/.c    - åŠ å¯†å·¥å…·
â”‚   â””â”€â”€ Makefile      - ç¼–è¯‘é…ç½®
â”œâ”€â”€ metrics/          - ç›‘æ§æŒ‡æ ‡æ¨¡å— âœ… å®Œå…¨å®ç°
â”‚   â”œâ”€â”€ metrics.h/.c  - æ ¸å¿ƒæŒ‡æ ‡å¼•æ“
â”‚   â”œâ”€â”€ metrics_format.c - æ ¼å¼åŒ–è¾“å‡ºå’ŒHTTPæœåŠ¡
â”‚   â”œâ”€â”€ metrics_demo.c   - ç¤ºä¾‹ç¨‹åº
â”‚   â””â”€â”€ Makefile      - ç¼–è¯‘é…ç½®
â”œâ”€â”€ testing/          - æµ‹è¯•å·¥å…·æ¨¡å— âœ… å®Œå…¨å®ç°
â”‚   â”œâ”€â”€ testing.h     - ç»Ÿä¸€æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ mock_client.c - æ¨¡æ‹Ÿå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ fault_inject.c - æ•…éšœæ³¨å…¥
â”‚   â”œâ”€â”€ benchmark.c   - æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â”œâ”€â”€ test_data.c   - æµ‹è¯•æ•°æ®ç”Ÿæˆ
â”‚   â”œâ”€â”€ testing_demo.c - ç»¼åˆç¤ºä¾‹ç¨‹åº
â”‚   â””â”€â”€ Makefile      - ç¼–è¯‘é…ç½®
â””â”€â”€ doc/              - æ–‡æ¡£ç›®å½• âœ… å®Œå…¨å®ç°
    â”œâ”€â”€ README.md     - ä¸»æ–‡æ¡£(æœ¬æ–‡ä»¶)
    â”œâ”€â”€ api_reference.md - APIå‚è€ƒæ–‡æ¡£
    â”œâ”€â”€ architecture.md  - æ¶æ„è®¾è®¡æ–‡æ¡£
    â””â”€â”€ examples.md   - ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
```

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”§ é…ç½®ç®¡ç†
- **å¤šæºé…ç½®**ï¼šæ”¯æŒYAMLã€JSONã€INIç­‰æ ¼å¼
- **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹é…ç½®è®¿é—®æ¥å£
- **çƒ­æ›´æ–°**ï¼šè¿è¡Œæ—¶é…ç½®å˜æ›´é€šçŸ¥
- **é»˜è®¤å€¼**ï¼šä¼˜é›…çš„é»˜è®¤å€¼å¤„ç†

### ğŸ› ï¸ é€šç”¨å·¥å…·
- **å­—ç¬¦ä¸²æ“ä½œ**ï¼šåˆ†å‰²ã€è¿æ¥ã€æ›¿æ¢ç­‰é«˜æ•ˆå®ç°
- **æ–‡ä»¶æ“ä½œ**ï¼šè¯»å†™ã€å¤åˆ¶ã€ç›®å½•ç®¡ç†
- **ç½‘ç»œå·¥å…·**ï¼šHTTPå®¢æˆ·ç«¯ã€å¥—æ¥å­—æ“ä½œ
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šåˆ†çº§æ—¥å¿—ã€ç»“æ„åŒ–è¾“å‡º
- **æ—¶é—´å·¥å…·**ï¼šé«˜ç²¾åº¦æ—¶é—´æˆ³ã€æ ¼å¼åŒ–

### ğŸ“Š ç›‘æ§æŒ‡æ ‡ (å·²å®Œå…¨å®ç°)
- **å››ç§æŒ‡æ ‡ç±»å‹**ï¼šCounterã€Gaugeã€Histogramã€Meter
- **çº¿ç¨‹å®‰å…¨**ï¼šæ— é”è®¾è®¡ï¼Œé«˜å¹¶å‘æ€§èƒ½
- **å¤šç§è¾“å‡ºæ ¼å¼**ï¼šæ–‡æœ¬ã€JSONã€Prometheus
- **HTTPæœåŠ¡å™¨**ï¼šå†…ç½®æŒ‡æ ‡æš´éœ²æœåŠ¡
- **ç™¾åˆ†ä½æ•°ç»Ÿè®¡**ï¼šP50ã€P90ã€P95ã€P99ç­‰
- **é€Ÿç‡è®¡ç®—**ï¼š1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿç§»åŠ¨å¹³å‡

### ğŸ§ª æµ‹è¯•å·¥å…· (å·²å®Œå…¨å®ç°)
- **æ¨¡æ‹Ÿå®¢æˆ·ç«¯**ï¼šå¤šçº¿ç¨‹è´Ÿè½½ç”Ÿæˆï¼Œå¯é…ç½®è¯»å†™æ¯”ä¾‹
- **æ•…éšœæ³¨å…¥**ï¼šç½‘ç»œã€CPUã€å†…å­˜ç­‰å¤šç§æ•…éšœç±»å‹
- **åŸºå‡†æµ‹è¯•**ï¼šè¯¦ç»†æ€§èƒ½åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ
- **æ•°æ®ç”Ÿæˆ**ï¼šæ”¯æŒæ¨¡å¼å’ŒZipfåˆ†å¸ƒçš„æµ‹è¯•æ•°æ®
- **ç»Ÿè®¡åˆ†æ**ï¼šå»¶è¿Ÿåˆ†å¸ƒã€ååé‡ã€æˆåŠŸç‡ç­‰æŒ‡æ ‡

## å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/ConcordKV.git
cd ConcordKV/common

# ç¼–è¯‘å„ä¸ªæ¨¡å—
make -C config
make -C util  
make -C metrics
make -C testing
```

### åŸºæœ¬ä½¿ç”¨

```c
#include "config/config.h"
#include "metrics/metrics.h"
#include "testing/testing.h"

int main() {
    // åŠ è½½é…ç½®
    concord_config_t *cfg = concord_config_load("app.yaml");
    
    // åˆ›å»ºæŒ‡æ ‡ä»“åº“
    concord_metrics_repo_t *metrics = concord_metrics_repo_create(64);
    
    // åˆ›å»ºè®¡æ•°å™¨
    concord_metric_t *counter = concord_metrics_create_counter(
        metrics, "requests_total", "è¯·æ±‚æ€»æ•°", 0);
    
    // ä½¿ç”¨æŒ‡æ ‡
    concord_metrics_counter_inc(counter, 1);
    
    // å¯åŠ¨æŒ‡æ ‡HTTPæœåŠ¡å™¨  
    concord_metrics_start_server(metrics, "0.0.0.0", 8080, "/metrics");
    
    // æ¸…ç†èµ„æº
    concord_config_destroy(cfg);
    concord_metrics_repo_destroy(metrics);
    
    return 0;
}
```

## è¿è¡Œç¤ºä¾‹ç¨‹åº

### ç›‘æ§æŒ‡æ ‡æ¼”ç¤º

```bash
cd metrics
make
./metrics_demo
# è®¿é—® http://localhost:8080/metrics æŸ¥çœ‹æŒ‡æ ‡
```

### æµ‹è¯•å·¥å…·æ¼”ç¤º

```bash
cd testing  
make
./testing_demo
# è§‚å¯Ÿæ¨¡æ‹Ÿå®¢æˆ·ç«¯ã€æ•…éšœæ³¨å…¥ã€åŸºå‡†æµ‹è¯•ç­‰åŠŸèƒ½
```

## APIå‚è€ƒ

è¯¦ç»†çš„APIæ–‡æ¡£è¯·å‚é˜…ï¼š

- [APIå‚è€ƒæ–‡æ¡£](doc/api_reference.md) - å®Œæ•´çš„APIæ¥å£è¯´æ˜
- [æ¶æ„è®¾è®¡æ–‡æ¡£](doc/architecture.md) - ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡æ€è·¯  
- [ä½¿ç”¨ç¤ºä¾‹æ–‡æ¡£](doc/examples.md) - è¯¦ç»†ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

## å·²å®ç°åŠŸèƒ½çŠ¶æ€

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **metrics** | âœ… å®Œå…¨å®ç° | 4ç§æŒ‡æ ‡ç±»å‹ï¼ŒHTTPæœåŠ¡å™¨ï¼Œå¤šæ ¼å¼è¾“å‡º |
| **testing** | âœ… å®Œå…¨å®ç° | æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œæ•…éšœæ³¨å…¥ï¼ŒåŸºå‡†æµ‹è¯•ï¼Œæ•°æ®ç”Ÿæˆ |
| **doc** | âœ… å®Œå…¨å®ç° | APIæ–‡æ¡£ï¼Œæ¶æ„æ–‡æ¡£ï¼Œç¤ºä¾‹æ–‡æ¡£ |
| config | ğŸ”¨ éƒ¨åˆ†å®ç° | åŸºç¡€æ¡†æ¶å·²æ­å»ºï¼Œéœ€å®Œå–„è§£æå™¨ |
| util | ğŸ”¨ éƒ¨åˆ†å®ç° | åŸºç¡€å·¥å…·å·²å®ç°ï¼Œéœ€æ‰©å±•ç½‘ç»œå’Œæ—¥å¿— |

## æ€§èƒ½ç‰¹æ€§

### ç›‘æ§æŒ‡æ ‡æ€§èƒ½
- **ä½å»¶è¿Ÿ**ï¼šæŒ‡æ ‡æ“ä½œé€šå¸¸åœ¨å¾®ç§’çº§åˆ«
- **é«˜å¹¶å‘**ï¼šæ”¯æŒæ•°åƒå¹¶å‘çº¿ç¨‹å®‰å…¨æ“ä½œ
- **å†…å­˜æ•ˆç‡**ï¼šå“ˆå¸Œè¡¨å­˜å‚¨ï¼ŒO(1)æŸ¥æ‰¾å¤æ‚åº¦
- **å¿«é€Ÿå¯¼å‡º**ï¼šæ”¯æŒå¤šç§æ ¼å¼çš„é«˜æ•ˆåºåˆ—åŒ–

### æµ‹è¯•å·¥å…·æ€§èƒ½
- **é«˜ååé‡**ï¼šå•æœºå¯æ¨¡æ‹Ÿæ•°ä¸‡QPSè´Ÿè½½
- **ç²¾ç¡®ç»Ÿè®¡**ï¼šå¾®ç§’çº§å»¶è¿Ÿæµ‹é‡ç²¾åº¦
- **èµ„æºæ§åˆ¶**ï¼šå¯é…ç½®çš„å†…å­˜å’ŒCPUä½¿ç”¨é™åˆ¶
- **å®æ—¶ç›‘æ§**ï¼šæµ‹è¯•è¿‡ç¨‹ä¸­çš„å®æ—¶æŒ‡æ ‡å±•ç¤º

## çº¿ç¨‹å®‰å…¨

æ‰€æœ‰å…¬å…±APIéƒ½ç»è¿‡çº¿ç¨‹å®‰å…¨è®¾è®¡ï¼š

- **metrics**ï¼šä½¿ç”¨åŸå­æ“ä½œï¼Œå®Œå…¨æ— é”
- **testing**ï¼šå†…éƒ¨çº¿ç¨‹åŒæ­¥ï¼Œå¤–éƒ¨è°ƒç”¨å®‰å…¨
- **config**ï¼šè¯»æ“ä½œçº¿ç¨‹å®‰å…¨ï¼Œå†™æ“ä½œéœ€å¤–éƒ¨åŒæ­¥
- **util**ï¼šå¤§éƒ¨åˆ†å‡½æ•°çº¿ç¨‹å®‰å…¨ï¼Œå…·ä½“è§APIæ–‡æ¡£

## é”™è¯¯å¤„ç†

ç»Ÿä¸€çš„é”™è¯¯å¤„ç†çº¦å®šï¼š

- è¿”å›æŒ‡é’ˆçš„å‡½æ•°ï¼šæˆåŠŸè¿”å›æœ‰æ•ˆæŒ‡é’ˆï¼Œå¤±è´¥è¿”å›`NULL`
- è¿”å›æ•´æ•°çš„å‡½æ•°ï¼šæˆåŠŸè¿”å›`0`ï¼Œå¤±è´¥è¿”å›`-1`  
- è·å–å€¼çš„å‡½æ•°ï¼šå¤±è´¥æ—¶è¿”å›é»˜è®¤å€¼

## ç¤ºä¾‹åœºæ™¯

### 1. WebæœåŠ¡å™¨ç›‘æ§

```c
// åˆ›å»ºHTTPè¯·æ±‚ç›¸å…³æŒ‡æ ‡
concord_metric_t *requests = concord_metrics_create_counter(repo, "http_requests_total", "HTTPè¯·æ±‚æ€»æ•°", 0);
concord_metric_t *latency = concord_metrics_create_histogram(repo, "http_request_duration_ms", "è¯·æ±‚å»¶è¿Ÿ", &hist_config);

// åœ¨è¯·æ±‚å¤„ç†ä¸­ä½¿ç”¨
void handle_request() {
    uint64_t start = get_time_us();
    
    // å¤„ç†è¯·æ±‚...
    
    // æ›´æ–°æŒ‡æ ‡
    concord_metrics_counter_inc(requests, 1);
    concord_metrics_histogram_observe(latency, (get_time_us() - start) / 1000.0);
}
```

### 2. æ•°æ®åº“è¿æ¥æ± ç›‘æ§

```c
// åˆ›å»ºè¿æ¥æ± æŒ‡æ ‡
concord_metric_t *active_conns = concord_metrics_create_gauge(repo, "db_connections_active", "æ´»è·ƒè¿æ¥æ•°", 0);
concord_metric_t *total_conns = concord_metrics_create_gauge(repo, "db_connections_total", "æ€»è¿æ¥æ•°", 0);

// è¿æ¥è·å–/é‡Šæ”¾æ—¶æ›´æ–°
void acquire_connection() {
    concord_metrics_gauge_inc(active_conns, 1);
}

void release_connection() {
    concord_metrics_gauge_inc(active_conns, -1);
}
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

```c
// åˆ›å»ºåŸºå‡†æµ‹è¯•
concord_benchmark_t *benchmark = concord_benchmark_create("æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½");
concord_benchmark_start(benchmark);

// æ‰§è¡Œæµ‹è¯•æ“ä½œ
for (int i = 0; i < 10000; i++) {
    uint64_t start_time = concord_benchmark_op_start(benchmark);
    
    // æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
    int success = execute_query();
    
    concord_benchmark_op_end(benchmark, start_time, success);
}

concord_benchmark_stop(benchmark);
concord_benchmark_print_report(benchmark);
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæå‡ºæ”¹è¿›å»ºè®®ï¼

1. Fork é¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼š`git checkout -b feature/new-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -am 'Add new feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/new-feature`  
5. åˆ›å»º Pull Request

## å¼€å‘è·¯çº¿å›¾

### ä¸‹ä¸€æ­¥è®¡åˆ’
- [ ] å®Œå–„configæ¨¡å—çš„è§£æå™¨å®ç°
- [ ] æ‰©å±•utilæ¨¡å—çš„ç½‘ç»œå’Œæ—¥å¿—åŠŸèƒ½
- [ ] æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹å’Œæ–‡æ¡£
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ä½¿ç”¨ä¼˜åŒ–
- [ ] æ”¯æŒæ›´å¤šé…ç½®æ ¼å¼å’Œè¾“å‡ºæ ¼å¼

### é•¿æœŸç›®æ ‡
- [ ] åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒé›†æˆ
- [ ] æŒ‡æ ‡æ•°æ®æŒä¹…åŒ–å­˜å‚¨
- [ ] å¯è§†åŒ–ç›‘æ§ç•Œé¢
- [ ] è‡ªåŠ¨åŒ–æ•…éšœæ£€æµ‹å’Œæ¢å¤

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦æƒ…è¯·å‚é˜… [LICENSE](../LICENSE) æ–‡ä»¶ã€‚

## è”ç³»æ–¹å¼

- é¡¹ç›®ä¸»é¡µï¼šhttps://github.com/your-org/ConcordKV
- é—®é¢˜åé¦ˆï¼šhttps://github.com/your-org/ConcordKV/issues
- æŠ€æœ¯è®¨è®ºï¼šhttps://github.com/your-org/ConcordKV/discussions 