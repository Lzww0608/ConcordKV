# ConcordKV å¢å¼ºæŒä¹…åŒ–åŠŸèƒ½

æœ¬æ–‡æ¡£ä»‹ç»äº† ConcordKV é¡¹ç›®ä¸­æ–°å¢çš„å¢å¼ºæŒä¹…åŒ–åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ—¥å¿—å‹ç¼©å’Œå¢é‡æŒä¹…åŒ–ç­‰ç‰¹æ€§ã€‚

## ğŸš€ æ–°å¢åŠŸèƒ½æ¦‚è§ˆ

### 1. æ—¥å¿—å‹ç¼© (Log Compaction)
- **è‡ªåŠ¨å‹ç¼©**: å½“WALæ—¥å¿—æ¡ç›®è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨è§¦å‘å‹ç¼©
- **ç©ºé—´ä¼˜åŒ–**: ç§»é™¤å†—ä½™çš„å†å²æ“ä½œï¼Œåªä¿ç•™æœ€æ–°çŠ¶æ€
- **åå°å¤„ç†**: å‹ç¼©è¿‡ç¨‹åœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œï¼Œä¸å½±å“æ­£å¸¸æ“ä½œ
- **å¯é…ç½®**: æ”¯æŒè‡ªå®šä¹‰å‹ç¼©é˜ˆå€¼å’Œæ¯”ä¾‹

### 2. å¢é‡æŒä¹…åŒ– (Incremental Persistence)
- **æ‰¹é‡åŒæ­¥**: æ”¯æŒæ‰¹é‡å†™å…¥åå†åŒæ­¥åˆ°ç£ç›˜
- **å®šæ—¶åŒæ­¥**: å¯é…ç½®çš„å®šæ—¶åŒæ­¥é—´éš”
- **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ç£ç›˜I/Oæ“ä½œï¼Œæé«˜å†™å…¥æ€§èƒ½
- **æ•°æ®å®‰å…¨**: ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§

### 3. æ—¥å¿—è½®è½¬ (Log Rotation)
- **æ–‡ä»¶å¤§å°æ§åˆ¶**: å½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡æŒ‡å®šå¤§å°æ—¶è‡ªåŠ¨è½®è½¬
- **æ–‡ä»¶ç®¡ç†**: è‡ªåŠ¨ç®¡ç†å¤šä¸ªæ—¥å¿—æ–‡ä»¶
- **å†å²æ¸…ç†**: æ”¯æŒæ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶

### 4. å¢é‡å¿«ç…§ (Incremental Snapshots)
- **å¢é‡å¤‡ä»½**: åªå¤‡ä»½å˜æ›´çš„æ•°æ®
- **å¿«é€Ÿæ¢å¤**: æ”¯æŒä»å¢é‡å¿«ç…§å¿«é€Ÿæ¢å¤
- **å­˜å‚¨ä¼˜åŒ–**: å‡å°‘å¿«ç…§æ–‡ä»¶å¤§å°

### 5. æ€§èƒ½ç›‘æ§ (Performance Monitoring)
- **å®æ—¶ç»Ÿè®¡**: æä¾›å†™å…¥ã€åŒæ­¥ã€å‹ç¼©ç­‰æ“ä½œçš„æ€§èƒ½ç»Ÿè®¡
- **å»¶è¿Ÿç›‘æ§**: ç›‘æ§å„ç§æ“ä½œçš„å»¶è¿Ÿæƒ…å†µ
- **ååé‡ç»Ÿè®¡**: ç»Ÿè®¡ç³»ç»Ÿçš„ååé‡æŒ‡æ ‡

## ğŸ“ æ–‡ä»¶ç»“æ„

```
ConcordKV/tests/
â”œâ”€â”€ enhanced_persistence_test.c     # åŠŸèƒ½æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ persistence_benchmark.c         # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”œâ”€â”€ Makefile.enhanced               # ç¼–è¯‘é…ç½®
â”œâ”€â”€ run_enhanced_tests.sh           # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â””â”€â”€ README_ENHANCED.md              # æœ¬æ–‡æ¡£

ConcordKV/kvserver/
â”œâ”€â”€ kv_persist.h                    # å¢å¼ºçš„æŒä¹…åŒ–å¤´æ–‡ä»¶
â”œâ”€â”€ kv_persist_enhanced.c           # å¢å¼ºçš„WALå®ç°
â””â”€â”€ kv_snapshot_enhanced.c          # å¢å¼ºçš„å¿«ç…§å®ç°
```

## ğŸ”§ ç¼–è¯‘å’Œè¿è¡Œ

### å‰ç½®è¦æ±‚
- GCC ç¼–è¯‘å™¨ (æ”¯æŒ C99 æ ‡å‡†)
- pthread åº“
- make å·¥å…·
- å¯é€‰: valgrind (ç”¨äºå†…å­˜æ£€æŸ¥)

### å¿«é€Ÿå¼€å§‹

1. **è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•**:
```bash
cd ConcordKV/tests
./run_enhanced_tests.sh
```

2. **è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•**:
```bash
./run_enhanced_tests.sh --benchmark
```

3. **è¿è¡Œå†…å­˜æ£€æŸ¥**:
```bash
./run_enhanced_tests.sh --valgrind
```

### æ‰‹åŠ¨ç¼–è¯‘

```bash
# ç¼–è¯‘åŠŸèƒ½æµ‹è¯•
make -f Makefile.enhanced all

# è¿è¡Œæµ‹è¯•
./enhanced_persistence_test

# ç¼–è¯‘æ€§èƒ½åŸºå‡†æµ‹è¯•
gcc -Wall -Wextra -std=c99 -g -O2 -pthread -I../kvserver \
    -o persistence_benchmark \
    persistence_benchmark.c \
    ../kvserver/kv_persist_enhanced.c \
    ../kvserver/kv_snapshot_enhanced.c \
    -lpthread

# è¿è¡ŒåŸºå‡†æµ‹è¯•
./persistence_benchmark
```

## ğŸ“Š API ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬WALæ“ä½œ

```c
#include "kv_persist.h"

// åˆå§‹åŒ–WAL
wal_t wal;
wal_init(&wal, "/path/to/logs", 1); // 1è¡¨ç¤ºåŒæ­¥å†™å…¥

// æ·»åŠ æ—¥å¿—æ¡ç›®
wal_append(&wal, WAL_OP_SET, "key1", "value1");
wal_append(&wal, WAL_OP_DEL, "key2", NULL);

// å¼ºåˆ¶åŒæ­¥
wal_force_sync(&wal);

// æ¸…ç†
wal_destroy(&wal);
```

### æ—¥å¿—å‹ç¼©

```c
// å¯åŠ¨è‡ªåŠ¨å‹ç¼©
wal_start_compaction(&wal, engine, get_all_keys_callback);

// æ‰‹åŠ¨è§¦å‘å‹ç¼©
wal_compact_logs(&wal, engine, get_all_keys_callback, get_value_callback);

// æ¸…ç†æ—§æ—¥å¿—
wal_cleanup_old_logs(&wal, before_sequence_number);
```

### å¢é‡åŒæ­¥

```c
// å¯åŠ¨å¢é‡åŒæ­¥çº¿ç¨‹
wal_start_incremental_sync(&wal, engine);

// æ‰‹åŠ¨å¢é‡åŒæ­¥
wal_incremental_sync(&wal, engine);
```

### å¿«ç…§æ“ä½œ

```c
snapshot_t snap;
snapshot_init(&snap, "/path/to/snapshots");

// åˆ›å»ºå®Œæ•´å¿«ç…§
snapshot_create(&snap, engine, save_data_callback);

// åˆ›å»ºå¢é‡å¿«ç…§
snapshot_create_incremental(&snap, engine, from_seq, to_seq, save_incremental_callback);

// åŠ è½½å¿«ç…§
snapshot_load(&snap, engine, load_data_callback);

// åº”ç”¨å¢é‡å¿«ç…§
snapshot_apply_incremental(&snap, engine, apply_incremental_callback);

snapshot_destroy(&snap);
```

## âš™ï¸ é…ç½®å‚æ•°

### WALé…ç½®
```c
#define WAL_COMPACT_THRESHOLD    1000    // è§¦å‘å‹ç¼©çš„æ—¥å¿—æ¡ç›®æ•°
#define WAL_COMPACT_RATIO        0.3     // å‹ç¼©æ¯”ä¾‹é˜ˆå€¼
#define WAL_MAX_FILE_SIZE        (64 * 1024 * 1024)  // æœ€å¤§æ–‡ä»¶å¤§å° 64MB
```

### å¢é‡åŒæ­¥é…ç½®
```c
#define INCREMENTAL_SYNC_INTERVAL  5     // å¢é‡åŒæ­¥é—´éš”(ç§’)
#define INCREMENTAL_BATCH_SIZE     100   // å¢é‡æ‰¹å¤„ç†å¤§å°
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### åŠŸèƒ½æµ‹è¯•
- âœ… åŸºæœ¬WALåŠŸèƒ½
- âœ… æ—¥å¿—è½®è½¬
- âœ… æ—¥å¿—å‹ç¼©
- âœ… å¢é‡åŒæ­¥
- âœ… å¿«ç…§åˆ›å»ºå’Œæ¢å¤
- âœ… å¢é‡å¿«ç…§
- âœ… å¹¶å‘æ“ä½œ
- âœ… é”™è¯¯å¤„ç†

### æ€§èƒ½æµ‹è¯•
- âœ… å•çº¿ç¨‹å†™å…¥æ€§èƒ½
- âœ… å¤šçº¿ç¨‹å¹¶å‘æ€§èƒ½
- âœ… åŒæ­¥ vs å¼‚æ­¥æ€§èƒ½å¯¹æ¯”
- âœ… å†…å­˜ä½¿ç”¨ç›‘æ§
- âœ… å»¶è¿Ÿåˆ†æ (å¹³å‡å€¼å’ŒP99)

### å‹åŠ›æµ‹è¯•
- âœ… å¤§é‡æ•°æ®å†™å…¥
- âœ… é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
- âœ… å†…å­˜æ³„æ¼æ£€æŸ¥
- âœ… å¹¶å‘å®‰å…¨æ€§

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡
- **å†™å…¥ååé‡**: 10,000+ ops/sec (å¼‚æ­¥æ¨¡å¼)
- **åŒæ­¥å»¶è¿Ÿ**: < 1ms (å¹³å‡)
- **å‹ç¼©æ•ˆç‡**: 30-70% ç©ºé—´èŠ‚çœ
- **å†…å­˜ä½¿ç”¨**: < 100MB (æ­£å¸¸è´Ÿè½½)

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. **å¼‚æ­¥æ¨¡å¼**: å¯¹äºé«˜ååé‡åœºæ™¯ï¼Œä½¿ç”¨å¼‚æ­¥å†™å…¥æ¨¡å¼
2. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨å¢é‡åŒæ­¥å‡å°‘ç£ç›˜I/O
3. **å®šæœŸå‹ç¼©**: é…ç½®åˆé€‚çš„å‹ç¼©é˜ˆå€¼
4. **å†…å­˜ç®¡ç†**: å®šæœŸæ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼–è¯‘é”™è¯¯**:
   - ç¡®ä¿å®‰è£…äº† pthread åº“
   - æ£€æŸ¥ GCC ç‰ˆæœ¬æ˜¯å¦æ”¯æŒ C99

2. **æµ‹è¯•è¶…æ—¶**:
   - æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
   - å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®

3. **å†…å­˜æ³„æ¼**:
   - ä½¿ç”¨ valgrind æ£€æŸ¥
   - ç¡®ä¿æ­£ç¡®è°ƒç”¨ destroy å‡½æ•°

4. **æ€§èƒ½é—®é¢˜**:
   - æ£€æŸ¥ç£ç›˜I/Oæ€§èƒ½
   - è°ƒæ•´åŒæ­¥ç­–ç•¥
   - ä¼˜åŒ–å‹ç¼©å‚æ•°

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼**:
```bash
make -f Makefile.enhanced debug
```

2. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:
```bash
export DEBUG=1
./enhanced_persistence_test
```

3. **å†…å­˜æ£€æŸ¥**:
```bash
valgrind --leak-check=full ./enhanced_persistence_test
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä»£ç è§„èŒƒ
- éµå¾ª C99 æ ‡å‡†
- ä½¿ç”¨ä¸€è‡´çš„å‘½åçº¦å®š
- æ·»åŠ é€‚å½“çš„æ³¨é‡Š
- åŒ…å«å•å…ƒæµ‹è¯•

### æäº¤æµç¨‹
1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. ç¼–å†™æµ‹è¯•
4. æäº¤ Pull Request

### æµ‹è¯•è¦æ±‚
- æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»åŒ…å«æµ‹è¯•
- æµ‹è¯•è¦†ç›–ç‡ > 90%
- é€šè¿‡å†…å­˜æ£€æŸ¥
- æ€§èƒ½å›å½’æµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æ–™

- [ConcordKV æ¶æ„æ–‡æ¡£](../ARCHITECTURE.md)
- [å¼€å‘è·¯çº¿å›¾](../docs/ROADMAP.md)
- [è´¡çŒ®æŒ‡å—](../CONTRIBUTING.md)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªå¼€å‘ä¸­çš„åŠŸèƒ½ï¼ŒAPI å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚ 