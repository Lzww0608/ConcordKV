# ConcordKV io_uring çœŸæ­£å¼‚æ­¥I/Oå®ç°

## é¡¹ç›®æ¦‚è¿°

æ ¹æ®ROADMAP Phase 4.1çš„è§„åˆ’ï¼Œæˆ‘ä»¬å®ç°äº†åŸºäºio_uringçš„çœŸæ­£å¼‚æ­¥I/OåŠŸèƒ½ï¼Œé‡‡ç”¨"å°æ­¥å¿«è·‘ï¼Œè´¨é‡ä¼˜å…ˆ"çš„å¼€å‘æ¨¡å¼ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **çœŸæ­£å¼‚æ­¥I/O**: åŸºäºLinux io_uringå®ç°çš„é›¶æ‹·è´å¼‚æ­¥I/O
- **é«˜æ€§èƒ½**: æ‰¹é‡æ“ä½œï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨å¼€é”€
- **çº¿ç¨‹å®‰å…¨**: å®Œå–„çš„å¹¶å‘æ§åˆ¶æœºåˆ¶
- **è¶…æ—¶ä¿æŠ¤**: å†…ç½®è¶…æ—¶æœºåˆ¶é˜²æ­¢æ­»é”
- **å›è°ƒæœºåˆ¶**: çµæ´»çš„å¼‚æ­¥å›è°ƒå¤„ç†

### ğŸ“Š æ”¯æŒçš„æ“ä½œç±»å‹
- `READ/WRITE`: åŸºç¡€è¯»å†™æ“ä½œ
- `READV/WRITEV`: å‘é‡åŒ–I/Oæ“ä½œ
- `FSYNC/FDATASYNC`: æ•°æ®åŒæ­¥æ“ä½œ
- `æ‰¹é‡æ“ä½œ`: æ”¯æŒæ‰¹é‡æäº¤å¤šä¸ªI/Oè¯·æ±‚

### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½å†…å­˜æ± ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯ç å’Œå¼‚å¸¸å¤„ç†
- **çŠ¶æ€è·Ÿè¸ª**: è¯·æ±‚çŠ¶æ€å…¨ç¨‹å¯è§
- **èµ„æºæ¸…ç†**: è‡ªåŠ¨èµ„æºé‡Šæ”¾æœºåˆ¶

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚æ¥å£                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  kv_uring_read_async() | kv_uring_write_async()        â”‚
â”‚  kv_uring_readv_async() | kv_uring_writev_async()      â”‚
â”‚  kv_uring_fsync_async() | kv_uring_batch_*()           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ç®¡ç†å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯·æ±‚ç®¡ç† | é…ç½®ç®¡ç† | ç»Ÿè®¡ç®¡ç† | å›è°ƒå¤„ç†               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   æ ¸å¿ƒå±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  io_uringç¯ | SQE/CQEå¤„ç† | å®Œæˆçº¿ç¨‹ | å†…å­˜æ±            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ç³»ç»Ÿå±‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                 Linux io_uring                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»“æ„

```
io_uring_tests/
â”œâ”€â”€ kv_io_uring.h              # å¤´æ–‡ä»¶ - å®Œæ•´çš„APIå®šä¹‰
â”œâ”€â”€ kv_io_uring.c              # å®ç°æ–‡ä»¶ - æ ¸å¿ƒåŠŸèƒ½å®ç°
â”œâ”€â”€ test_io_uring_basic.c      # åŸºç¡€æµ‹è¯•ç¨‹åº
â”œâ”€â”€ CMakeLists.txt             # CMakeæ„å»ºé…ç½®
â”œâ”€â”€ build_and_test.sh          # æ„å»ºå’Œæµ‹è¯•è„šæœ¬
â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

1. **Linuxå†…æ ¸**: ç‰ˆæœ¬ 5.1+ (æ”¯æŒio_uring)
2. **liburing**: io_uringç”¨æˆ·æ€åº“
3. **CMake**: ç‰ˆæœ¬ 3.10+
4. **GCC**: æ”¯æŒC11æ ‡å‡†

### å®‰è£…ä¾èµ–

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y liburing-dev cmake build-essential

# CentOS/RHEL
sudo yum install -y liburing-devel cmake gcc

# æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
uname -r  # åº”è¯¥ >= 5.1
```

### æ„å»ºå’Œæµ‹è¯•

```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd ConcordKV/tests/kvserver_tests/io_uring_tests/

# æ‰§è¡Œå®Œæ•´æµç¨‹ï¼ˆæ¨èï¼‰
./build_and_test.sh

# æˆ–è€…åˆ†æ­¥æ‰§è¡Œ
./build_and_test.sh --clean    # æ¸…ç†
./build_and_test.sh --build    # æ„å»º
./build_and_test.sh --test     # æµ‹è¯•
```

## APIä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å¼‚æ­¥è¯»æ“ä½œ

```c
#include "kv_io_uring.h"

// å›è°ƒå‡½æ•°
void read_callback(kv_uring_request_t *req, int result, void *data) {
    if (result > 0) {
        printf("è¯»å–æˆåŠŸ: %d å­—èŠ‚\n", result);
    } else {
        printf("è¯»å–å¤±è´¥: %d\n", result);
    }
}

int main() {
    // åˆ›å»ºé…ç½®
    kv_uring_config_t *config = kv_uring_config_create();
    
    // åˆ›å»ºio_uringå®ä¾‹
    kv_uring_t *uring = kv_uring_create(config);
    
    // å‡†å¤‡ç¼“å†²åŒº
    char buffer[4096];
    int fd = open("test.txt", O_RDONLY);
    
    // æäº¤å¼‚æ­¥è¯»è¯·æ±‚
    kv_uring_request_t *request = kv_uring_read_async(
        uring, fd, buffer, sizeof(buffer), 0,
        read_callback, NULL
    );
    
    // ç­‰å¾…å®Œæˆï¼ˆå¸¦è¶…æ—¶ï¼‰
    kv_uring_wait_request(uring, request, 5000);
    
    // æ¸…ç†èµ„æº
    close(fd);
    kv_uring_destroy(uring);
    kv_uring_config_destroy(config);
    
    return 0;
}
```

### æ‰¹é‡æ“ä½œ

```c
// åˆ›å»ºæ‰¹é‡æ“ä½œ
kv_uring_batch_t *batch = kv_uring_batch_create(uring, 10);

// æ·»åŠ å¤šä¸ªæ“ä½œ
kv_uring_batch_add_read(batch, fd1, buffer1, size1, offset1, callback1, data1);
kv_uring_batch_add_write(batch, fd2, buffer2, size2, offset2, callback2, data2);

// æ‰¹é‡æäº¤
kv_uring_batch_submit(uring, batch);
```

## æµ‹è¯•è¦†ç›–

æˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºè¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

### ğŸ“‹ åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [x] io_uringæ”¯æŒæ£€æµ‹
- [x] é…ç½®åˆ›å»ºå’ŒéªŒè¯
- [x] å®ä¾‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [x] å¼‚æ­¥è¯»æ“ä½œ
- [x] å¼‚æ­¥å†™æ“ä½œ
- [x] å·¥å…·å‡½æ•°éªŒè¯



## æ€§èƒ½æŒ‡æ ‡

### è®¾è®¡ç›®æ ‡
- **å»¶è¿Ÿ**: < 100Î¼s (å¾®ç§’çº§å“åº”)
- **ååé‡**: > 100K IOPS
- **å†…å­˜å¼€é”€**: < 1MB (åŸºç¡€é…ç½®)
- **CPUå ç”¨**: < 5% (ç©ºé—²çŠ¶æ€)

### ä¼˜åŒ–ç‰¹æ€§
- **é›¶æ‹·è´**: å‡å°‘æ•°æ®æ‹·è´å¼€é”€
- **æ‰¹é‡æäº¤**: å•æ¬¡ç³»ç»Ÿè°ƒç”¨å¤„ç†å¤šä¸ªè¯·æ±‚
- **å†…å­˜æ± **: å‡å°‘å†…å­˜åˆ†é…å¼€é”€
- **è½®è¯¢æ¨¡å¼**: å¯é€‰çš„CPUè½®è¯¢æ¨¡å¼

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼–è¯‘é”™è¯¯: liburing not found**
   ```bash
   # è§£å†³æ–¹æ¡ˆï¼šå®‰è£…liburingå¼€å‘åº“
   sudo apt-get install liburing-dev
   ```

2. **è¿è¡Œæ—¶é”™è¯¯: Operation not supported**
   ```bash
   # è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
   uname -r  # éœ€è¦ >= 5.1
   ```

3. **æµ‹è¯•è¶…æ—¶**
   ```bash
   # è§£å†³æ–¹æ¡ˆï¼šå¢åŠ è¶…æ—¶æ—¶é—´æˆ–æ£€æŸ¥ç³»ç»ŸI/Oæ€§èƒ½
   # ä¿®æ”¹ TEST_TIMEOUT_MS å®å®šä¹‰
   ```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```bash
   export KV_URING_DEBUG=1
   ./test_io_uring_basic
   ```

2. **æ£€æŸ¥ç³»ç»Ÿèµ„æº**
   ```bash
   # æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
   ulimit -n
   
   # æ£€æŸ¥å†…å­˜ä½¿ç”¨
   free -h
   
   # æ£€æŸ¥io_uringæ”¯æŒ
   cat /proc/version
   ```

## å¼€å‘æŒ‡å—

### å°æ­¥å¿«è·‘åŸåˆ™

æˆ‘ä»¬é‡‡ç”¨å°æ­¥å¿«è·‘çš„å¼€å‘æ¨¡å¼ï¼š

1. **Phase 1 âœ…**: åŸºç¡€APIå’Œæ ¸å¿ƒåŠŸèƒ½
2. **Phase 2 ğŸ”„**: æ‰¹é‡æ“ä½œå’Œä¼˜åŒ–
3. **Phase 3 ğŸ“…**: é«˜çº§ç‰¹æ€§å’Œå·¥å…·
4. **Phase 4 ğŸ“…**: æ€§èƒ½è°ƒä¼˜å’Œç¨³å®šæ€§

### è´¨é‡ä¼˜å…ˆ

- **ä»£ç å®¡æŸ¥**: æ‰€æœ‰ä»£ç éƒ½ç»è¿‡ä¸¥æ ¼å®¡æŸ¥
- **å•å…ƒæµ‹è¯•**: 100%æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
- **å†…å­˜å®‰å…¨**: ä½¿ç”¨å·¥å…·æ£€æµ‹å†…å­˜é—®é¢˜
- **æ–‡æ¡£åŒæ­¥**: ä»£ç å’Œæ–‡æ¡£åŒæ­¥æ›´æ–°

### è´¡çŒ®æŒ‡å—

1. **Fork** ä»£ç ä»“åº“
2. **åˆ›å»º** åŠŸèƒ½åˆ†æ”¯
3. **ç¼–å†™** æµ‹è¯•ç”¨ä¾‹
4. **æäº¤** Pull Request
5. **ä»£ç å®¡æŸ¥** é€šè¿‡ååˆå¹¶

## æŠ€æœ¯åˆ†æ

### ä¸ä¼ ç»ŸI/Oçš„å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»ŸåŒæ­¥I/O | epoll + AIO | io_uring |
|------|-------------|-------------|----------|
| ç³»ç»Ÿè°ƒç”¨å¼€é”€ | é«˜ | ä¸­ | ä½ |
| æ–‡ä»¶I/Oæ”¯æŒ | æœ‰é™ | æœ‰é™ | å®Œæ•´ |
| æ‰¹é‡æ“ä½œ | æ—  | æœ‰é™ | å®Œæ•´ |
| å†…å­˜æ‹·è´ | å¤šæ¬¡ | å¤šæ¬¡ | é›¶æ‹·è´ |
| å»¶è¿Ÿ | é«˜ | ä¸­ | ä½ |

### é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆçš„åœºæ™¯**:
- é«˜å¹¶å‘æ–‡ä»¶I/O
- æ‰¹é‡æ•°æ®å¤„ç†
- ä½å»¶è¿Ÿè¦æ±‚çš„åº”ç”¨
- ç½‘ç»œå’Œæ–‡ä»¶I/Oæ··åˆåœºæ™¯

âŒ **ä¸é€‚åˆçš„åœºæ™¯**:
- ç®€å•çš„å•æ¬¡I/Oæ“ä½œ
- å†…æ ¸ç‰ˆæœ¬ < 5.1 çš„ç³»ç»Ÿ
- å¯¹å…¼å®¹æ€§è¦æ±‚æé«˜çš„åœºæ™¯


