# LSM-Tree MemTableã€SSTableå’Œå‹ç¼©æœºåˆ¶æµ‹è¯•Makefile
# @Author: Lzww0608  
# @Date: 2025-6-2 23:45:25
# @LastEditTime: 2025-6-2 23:45:32

CC = gcc
CFLAGS = -Wall -Wextra -g -std=c99 -pthread -D_GNU_SOURCE
INCLUDES = -I../../../kvserver
LIBS = -lpthread -lm

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_SRC = ../../../kvserver
TEST_SRC = .

# ç›®æ ‡æ–‡ä»¶
MEMTABLE_MANAGER_TEST = lsm_memtable_manager_test
MEMTABLE_TEST = lsm_memtable_test
SSTABLE_TEST = lsm_sstable_test
COMPACTION_TEST = lsm_compaction_test

# LSMç›¸å…³æºæ–‡ä»¶
LSM_SOURCES = $(KVSERVER_SRC)/lsm_memtable.c \
              $(KVSERVER_SRC)/lsm_memtable_manager.c \
              $(KVSERVER_SRC)/lsm_sstable.c \
              $(KVSERVER_SRC)/lsm_compaction.c \
              $(KVSERVER_SRC)/kv_memory.c \
              $(KVSERVER_SRC)/kv_error.c

# æµ‹è¯•æºæ–‡ä»¶
TEST_SOURCES = lsm_memtable_manager_test.c lsm_sstable_test.c lsm_compaction_test.c

# ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
LSM_OBJECTS = $(patsubst $(KVSERVER_SRC)/%.c, %.o, $(LSM_SOURCES))
TEST_OBJECTS = $(patsubst %.c, %.o, $(TEST_SOURCES))

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test memtable_manager_test memtable_test sstable_test compaction_test help

all: $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST) $(SSTABLE_TEST) $(COMPACTION_TEST)

# æ„å»ºç®¡ç†å™¨æµ‹è¯•
$(MEMTABLE_MANAGER_TEST): $(LSM_OBJECTS) lsm_memtable_manager_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# æ„å»ºMemTableæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
$(MEMTABLE_TEST): $(LSM_OBJECTS) lsm_memtable_test.o
	@if [ -f "lsm_memtable_test.c" ]; then \
		echo "ğŸ”— é“¾æ¥ $@..."; \
		$(CC) $(CFLAGS) -o $@ $^ $(LIBS); \
		echo "âœ… æ„å»ºå®Œæˆ: $@"; \
	else \
		echo "â„¹ï¸  lsm_memtable_test.c ä¸å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"; \
	fi

# æ„å»ºSSTableæµ‹è¯•
$(SSTABLE_TEST): $(LSM_OBJECTS) lsm_sstable_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# æ„å»ºå‹ç¼©æœºåˆ¶æµ‹è¯•
$(COMPACTION_TEST): $(LSM_OBJECTS) lsm_compaction_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# ç¼–è¯‘è§„åˆ™
%.o: $(KVSERVER_SRC)/%.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# è¿è¡Œç®¡ç†å™¨æµ‹è¯•
test_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableç®¡ç†å™¨æµ‹è¯•..."
	@echo "=================================="
	./$(MEMTABLE_MANAGER_TEST)

# è¿è¡ŒMemTableæµ‹è¯•
test_memtable: $(MEMTABLE_TEST)
	@if [ -f "$(MEMTABLE_TEST)" ]; then \
		echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableæµ‹è¯•..."; \
		echo "=============================="; \
		./$(MEMTABLE_TEST); \
	else \
		echo "â„¹ï¸  MemTableæµ‹è¯•ç¨‹åºä¸å­˜åœ¨"; \
	fi

# è¿è¡ŒSSTableæµ‹è¯•
test_sstable: $(SSTABLE_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Tree SSTableæµ‹è¯•..."
	@echo "============================="
	./$(SSTABLE_TEST)

# è¿è¡Œå‹ç¼©æœºåˆ¶æµ‹è¯•
test_compaction: $(COMPACTION_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Treeå‹ç¼©æœºåˆ¶æµ‹è¯•..."
	@echo "=============================="
	./$(COMPACTION_TEST)

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test_manager test_memtable test_sstable test_compaction
	@echo ""
	@echo "ğŸ‰ LSM-Treeæ‰€æœ‰æµ‹è¯•å®Œæˆ!"

# å†…å­˜æ£€æŸ¥
memcheck_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥ï¼ˆç®¡ç†å™¨ï¼‰..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(MEMTABLE_MANAGER_TEST)

memcheck_sstable: $(SSTABLE_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥ï¼ˆSSTableï¼‰..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(SSTABLE_TEST)

memcheck_compaction: $(COMPACTION_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥ï¼ˆå‹ç¼©æœºåˆ¶ï¼‰..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(COMPACTION_TEST)

memcheck: memcheck_manager memcheck_sstable memcheck_compaction
	@echo "ğŸ‰ æ‰€æœ‰å†…å­˜æ£€æŸ¥å®Œæˆ!"

# æ€§èƒ½æµ‹è¯•
perf_test: $(MEMTABLE_MANAGER_TEST) $(SSTABLE_TEST) $(COMPACTION_TEST)
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@echo "=================="
	@echo "MemTableç®¡ç†å™¨æ€§èƒ½:"
	time ./$(MEMTABLE_MANAGER_TEST)
	@echo ""
	@echo "SSTableæ€§èƒ½:"
	time ./$(SSTABLE_TEST)
	@echo ""
	@echo "å‹ç¼©æœºåˆ¶æ€§èƒ½:"
	time ./$(COMPACTION_TEST)

# å‹åŠ›æµ‹è¯•
stress_test: $(MEMTABLE_MANAGER_TEST) $(SSTABLE_TEST) $(COMPACTION_TEST)
	@echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•ï¼ˆå¤šæ¬¡æ‰§è¡Œï¼‰..."
	@echo "=============================="
	@echo "ç®¡ç†å™¨å‹åŠ›æµ‹è¯•:"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(MEMTABLE_MANAGER_TEST) || exit 1; \
		echo ""; \
	done
	@echo "SSTableå‹åŠ›æµ‹è¯•:"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(SSTABLE_TEST) || exit 1; \
		echo ""; \
	done
	@echo "å‹ç¼©æœºåˆ¶å‹åŠ›æµ‹è¯•:"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(COMPACTION_TEST) || exit 1; \
		echo ""; \
	done
	@echo "âœ… å‹åŠ›æµ‹è¯•å…¨éƒ¨é€šè¿‡!"

# å¿«é€Ÿæµ‹è¯•ï¼ˆåªè¿è¡Œå‹ç¼©æœºåˆ¶ï¼‰
quick_test: $(COMPACTION_TEST)
	@echo "ğŸš€ å¿«é€Ÿå‹ç¼©æœºåˆ¶æµ‹è¯•..."
	@echo "===================="
	./$(COMPACTION_TEST)

# ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
production_test: $(SSTABLE_TEST) $(COMPACTION_TEST)
	@echo "ğŸ­ ç”Ÿäº§ç¯å¢ƒLSM-Treeæµ‹è¯•..."
	@echo "========================="
	@echo "è¿è¡Œå…¨é¢çš„SSTableåŠŸèƒ½éªŒè¯..."
	./$(SSTABLE_TEST)
	@echo ""
	@echo "è¿è¡Œå…¨é¢çš„å‹ç¼©æœºåˆ¶éªŒè¯..."
	./$(COMPACTION_TEST)
	@echo ""
	@echo "æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥..."
	@ls -la /tmp/*_test* 2>/dev/null || echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒæµ‹è¯•å®Œæˆ"

# å®Œæ•´çš„LSM-Treeé›†æˆæµ‹è¯•
integration_test: all
	@echo "ğŸ”— è¿è¡ŒLSM-Treeå®Œæ•´é›†æˆæµ‹è¯•..."
	@echo "============================="
	@echo "1. MemTableç®¡ç†å™¨æµ‹è¯•:"
	./$(MEMTABLE_MANAGER_TEST)
	@echo ""
	@echo "2. SSTableæ–‡ä»¶æ ¼å¼æµ‹è¯•:"
	./$(SSTABLE_TEST)
	@echo ""
	@echo "3. å‹ç¼©æœºåˆ¶æµ‹è¯•:"
	./$(COMPACTION_TEST)
	@echo ""
	@echo "ğŸ‰ LSM-Treeå®Œæ•´é›†æˆæµ‹è¯•é€šè¿‡!"

# å‹ç¼©æœºåˆ¶ä¸“é¡¹æµ‹è¯•
compaction_deep_test: $(COMPACTION_TEST)
	@echo "ğŸ” å‹ç¼©æœºåˆ¶æ·±åº¦æµ‹è¯•..."
	@echo "===================="
	@echo "æ ‡å‡†æµ‹è¯•:"
	./$(COMPACTION_TEST)
	@echo ""
	@echo "å†…å­˜æ£€æŸ¥æµ‹è¯•:"
	valgrind --leak-check=full --show-leak-kinds=all --error-exitcode=1 ./$(COMPACTION_TEST)
	@echo ""
	@echo "å¤šæ¬¡é‡å¤æµ‹è¯•:"
	@for i in 1 2 3 4 5; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(COMPACTION_TEST) || exit 1; \
	done
	@echo "âœ… å‹ç¼©æœºåˆ¶æ·±åº¦æµ‹è¯•å®Œæˆ!"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f *.o $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST) $(SSTABLE_TEST) $(COMPACTION_TEST)
	rm -f /tmp/test_*.sst /tmp/lsm_compaction_test*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "LSM-Tree MemTableã€SSTableå’Œå‹ç¼©æœºåˆ¶æµ‹è¯•Makefileä½¿ç”¨è¯´æ˜"
	@echo "======================================================="
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all                    - æ„å»ºæ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_MANAGER_TEST)  - æ„å»ºç®¡ç†å™¨æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_TEST)       - æ„å»ºMemTableæµ‹è¯•ç¨‹åº"
	@echo "  $(SSTABLE_TEST)        - æ„å»ºSSTableæµ‹è¯•ç¨‹åº"
	@echo "  $(COMPACTION_TEST)     - æ„å»ºå‹ç¼©æœºåˆ¶æµ‹è¯•ç¨‹åº"
	@echo ""
	@echo "æµ‹è¯•ç›®æ ‡:"
	@echo "  test                   - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test_manager           - è¿è¡Œç®¡ç†å™¨æµ‹è¯•"
	@echo "  test_memtable          - è¿è¡ŒMemTableæµ‹è¯•"
	@echo "  test_sstable           - è¿è¡ŒSSTableæµ‹è¯•"
	@echo "  test_compaction        - è¿è¡Œå‹ç¼©æœºåˆ¶æµ‹è¯•"
	@echo "  quick_test             - å¿«é€Ÿå‹ç¼©æœºåˆ¶æµ‹è¯•"
	@echo "  production_test        - ç”Ÿäº§ç¯å¢ƒæµ‹è¯•"
	@echo "  integration_test       - å®Œæ•´é›†æˆæµ‹è¯•"
	@echo "  compaction_deep_test   - å‹ç¼©æœºåˆ¶æ·±åº¦æµ‹è¯•"
	@echo ""
	@echo "è°ƒè¯•ç›®æ ‡:"
	@echo "  memcheck               - è¿è¡Œæ‰€æœ‰Valgrindå†…å­˜æ£€æŸ¥"
	@echo "  memcheck_manager       - è¿è¡Œç®¡ç†å™¨å†…å­˜æ£€æŸ¥"
	@echo "  memcheck_sstable       - è¿è¡ŒSSTableå†…å­˜æ£€æŸ¥"
	@echo "  memcheck_compaction    - è¿è¡Œå‹ç¼©æœºåˆ¶å†…å­˜æ£€æŸ¥"
	@echo "  perf_test              - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  stress_test            - è¿è¡Œå‹åŠ›æµ‹è¯•"
	@echo ""
	@echo "ç»´æŠ¤ç›®æ ‡:"
	@echo "  clean                  - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  help                   - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make                       # æ„å»ºæ‰€æœ‰æµ‹è¯•"
	@echo "  make test                  # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test_compaction       # åªè¿è¡Œå‹ç¼©æœºåˆ¶æµ‹è¯•"
	@echo "  make quick_test            # å¿«é€Ÿå‹ç¼©æœºåˆ¶æµ‹è¯•"
	@echo "  make integration_test      # å®Œæ•´é›†æˆæµ‹è¯•"
	@echo "  make compaction_deep_test  # å‹ç¼©æœºåˆ¶æ·±åº¦æµ‹è¯•"
	@echo "  make memcheck_compaction   # å‹ç¼©æœºåˆ¶å†…å­˜æ£€æŸ¥"
	@echo "  make clean                 # æ¸…ç†"

# æ£€æŸ¥ä¾èµ–
check_deps:
	@echo "ğŸ” æ£€æŸ¥ç¼–è¯‘ä¾èµ–..."
	@echo "=================="
	@echo "æ£€æŸ¥ç¼–è¯‘å™¨:"
	@which $(CC) >/dev/null && echo "âœ… $(CC) å¯ç”¨" || echo "âŒ $(CC) ä¸å¯ç”¨"
	@echo "æ£€æŸ¥pthreadåº“:"
	@echo "#include <pthread.h>" | $(CC) -x c -c - -o /dev/null 2>/dev/null && echo "âœ… pthread å¯ç”¨" || echo "âŒ pthread ä¸å¯ç”¨"
	@echo "æ£€æŸ¥æºæ–‡ä»¶:"
	@for src in $(LSM_SOURCES); do \
		if [ -f "$$src" ]; then \
			echo "âœ… $$src"; \
		else \
			echo "âŒ $$src (ç¼ºå¤±)"; \
		fi; \
	done
	@echo "æ£€æŸ¥æµ‹è¯•æ–‡ä»¶:"
	@for test in $(TEST_SOURCES); do \
		if [ -f "$$test" ]; then \
			echo "âœ… $$test"; \
		else \
			echo "âŒ $$test (ç¼ºå¤±)"; \
		fi; \
	done

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
version:
	@echo "LSM-Treeæµ‹è¯•å¥—ä»¶ç‰ˆæœ¬ä¿¡æ¯"
	@echo "======================"
	@echo "ç‰ˆæœ¬: 3.3 (å‹ç¼©æœºåˆ¶)"
	@echo "æ—¥æœŸ: 2025-6-1"
	@echo "åŠŸèƒ½: MemTable + SSTable + å‹ç¼©æœºåˆ¶"
	@echo "ç¼–è¯‘å™¨: $(CC)"
	@echo "ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "é“¾æ¥åº“: $(LIBS)" 