# LSM-Tree MemTableæµ‹è¯•Makefile
# @Author: Lzww0608  
# @Date: 2025-6-1 12:00:00

CC = gcc
CFLAGS = -Wall -Wextra -g -std=c99 -pthread
INCLUDES = -I../../../kvserver
LIBS = -lpthread

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_SRC = ../../../kvserver
TEST_SRC = .

# ç›®æ ‡æ–‡ä»¶
MEMTABLE_MANAGER_TEST = lsm_memtable_manager_test
MEMTABLE_TEST = lsm_memtable_test

# LSMç›¸å…³æºæ–‡ä»¶
LSM_SOURCES = $(KVSERVER_SRC)/lsm_memtable.c \
              $(KVSERVER_SRC)/lsm_memtable_manager.c \
              $(KVSERVER_SRC)/kv_memory.c \
              $(KVSERVER_SRC)/kv_error.c

# æµ‹è¯•æºæ–‡ä»¶
TEST_SOURCES = lsm_memtable_manager_test.c

# ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
LSM_OBJECTS = $(patsubst $(KVSERVER_SRC)/%.c, %.o, $(LSM_SOURCES))
TEST_OBJECTS = $(patsubst %.c, %.o, $(TEST_SOURCES))

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test memtable_manager_test memtable_test help

all: $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST)

# æ„å»ºç®¡ç†å™¨æµ‹è¯•
$(MEMTABLE_MANAGER_TEST): $(LSM_OBJECTS) lsm_memtable_manager_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# æ„å»ºMemTableæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
$(MEMTABLE_TEST): $(LSM_OBJECTS) lsm_memtable_test.o
	@if [ -f "lsm_memtable_test.c" ]; then \
		echo "ğŸ”— é“¾æ¥ $@..."; \
		$(CC) $(CFLAGS) -o $@ $^ $(LIBS); \
		echo "âœ… æ„å»ºå®Œæˆ: $@"; \
	else \
		echo "â„¹ï¸  lsm_memtable_test.c ä¸å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"; \
	fi

# ç¼–è¯‘è§„åˆ™
%.o: $(KVSERVER_SRC)/%.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# è¿è¡Œç®¡ç†å™¨æµ‹è¯•
test_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableç®¡ç†å™¨æµ‹è¯•..."
	@echo "=================================="
	./$(MEMTABLE_MANAGER_TEST)

# è¿è¡ŒMemTableæµ‹è¯•
test_memtable: $(MEMTABLE_TEST)
	@if [ -f "$(MEMTABLE_TEST)" ]; then \
		echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableæµ‹è¯•..."; \
		echo "=============================="; \
		./$(MEMTABLE_TEST); \
	else \
		echo "â„¹ï¸  MemTableæµ‹è¯•ç¨‹åºä¸å­˜åœ¨"; \
	fi

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test_manager test_memtable
	@echo ""
	@echo "ğŸ‰ LSM-Treeæµ‹è¯•å®Œæˆ!"

# å†…å­˜æ£€æŸ¥
memcheck_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(MEMTABLE_MANAGER_TEST)

# æ€§èƒ½æµ‹è¯•
perf_test: $(MEMTABLE_MANAGER_TEST)
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@echo "=================="
	time ./$(MEMTABLE_MANAGER_TEST)

# å‹åŠ›æµ‹è¯•
stress_test: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•ï¼ˆå¤šæ¬¡æ‰§è¡Œï¼‰..."
	@echo "=============================="
	@for i in 1 2 3 4 5; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(MEMTABLE_MANAGER_TEST) || exit 1; \
		echo ""; \
	done
	@echo "âœ… å‹åŠ›æµ‹è¯•å…¨éƒ¨é€šè¿‡!"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f *.o $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST)
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "LSM-Tree MemTableæµ‹è¯•Makefileä½¿ç”¨è¯´æ˜"
	@echo "======================================"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all                    - æ„å»ºæ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_MANAGER_TEST)  - æ„å»ºç®¡ç†å™¨æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_TEST)       - æ„å»ºMemTableæµ‹è¯•ç¨‹åº"
	@echo ""
	@echo "æµ‹è¯•ç›®æ ‡:"
	@echo "  test                   - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test_manager           - è¿è¡Œç®¡ç†å™¨æµ‹è¯•"
	@echo "  test_memtable          - è¿è¡ŒMemTableæµ‹è¯•"
	@echo ""
	@echo "è°ƒè¯•ç›®æ ‡:"
	@echo "  memcheck_manager       - è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥"
	@echo "  perf_test              - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  stress_test            - è¿è¡Œå‹åŠ›æµ‹è¯•"
	@echo ""
	@echo "ç»´æŠ¤ç›®æ ‡:"
	@echo "  clean                  - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  help                   - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make                   # æ„å»ºæ‰€æœ‰æµ‹è¯•"
	@echo "  make test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test_manager      # åªè¿è¡Œç®¡ç†å™¨æµ‹è¯•"
	@echo "  make memcheck_manager  # å†…å­˜æ£€æŸ¥"
	@echo "  make clean             # æ¸…ç†"

# æ£€æŸ¥ä¾èµ–
check_deps:
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–æ–‡ä»¶..."
	@echo "LSMæºæ–‡ä»¶æ£€æŸ¥:"
	@for file in $(LSM_SOURCES); do \
		if [ -f "$$file" ]; then \
			echo "  âœ… $$file"; \
		else \
			echo "  âŒ $$file (ç¼ºå¤±)"; \
		fi \
	done
	@echo ""
	@echo "æµ‹è¯•æ–‡ä»¶æ£€æŸ¥:"
	@for file in $(TEST_SOURCES); do \
		if [ -f "$$file" ]; then \
			echo "  âœ… $$file"; \
		else \
			echo "  âŒ $$file (ç¼ºå¤±)"; \
		fi \
	done

# æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
info:
	@echo "LSM-Treeæµ‹è¯•ç¼–è¯‘ä¿¡æ¯"
	@echo "==================="
	@echo "ç¼–è¯‘å™¨: $(CC)"
	@echo "ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "åŒ…å«è·¯å¾„: $(INCLUDES)"
	@echo "é“¾æ¥åº“: $(LIBS)"
	@echo ""
	@echo "LSMæºæ–‡ä»¶:"
	@for file in $(LSM_SOURCES); do echo "  $$file"; done
	@echo ""
	@echo "æµ‹è¯•æ–‡ä»¶:"
	@for file in $(TEST_SOURCES); do echo "  $$file"; done

.SUFFIXES: .c .o 