# LSM-Tree MemTableå’ŒSSTableæµ‹è¯•Makefile
# @Author: Lzww0608  
# @Date: 2025-6-1 12:00:00
# @LastEditTime: 2025-6-1 14:30:00

CC = gcc
CFLAGS = -Wall -Wextra -g -std=c99 -pthread
INCLUDES = -I../../../kvserver
LIBS = -lpthread -lm

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_SRC = ../../../kvserver
TEST_SRC = .

# ç›®æ ‡æ–‡ä»¶
MEMTABLE_MANAGER_TEST = lsm_memtable_manager_test
MEMTABLE_TEST = lsm_memtable_test
SSTABLE_TEST = lsm_sstable_test

# LSMç›¸å…³æºæ–‡ä»¶
LSM_SOURCES = $(KVSERVER_SRC)/lsm_memtable.c \
              $(KVSERVER_SRC)/lsm_memtable_manager.c \
              $(KVSERVER_SRC)/lsm_sstable.c \
              $(KVSERVER_SRC)/kv_memory.c \
              $(KVSERVER_SRC)/kv_error.c

# æµ‹è¯•æºæ–‡ä»¶
TEST_SOURCES = lsm_memtable_manager_test.c lsm_sstable_test.c

# ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
LSM_OBJECTS = $(patsubst $(KVSERVER_SRC)/%.c, %.o, $(LSM_SOURCES))
TEST_OBJECTS = $(patsubst %.c, %.o, $(TEST_SOURCES))

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test memtable_manager_test memtable_test sstable_test help

all: $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST) $(SSTABLE_TEST)

# æ„å»ºç®¡ç†å™¨æµ‹è¯•
$(MEMTABLE_MANAGER_TEST): $(LSM_OBJECTS) lsm_memtable_manager_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# æ„å»ºMemTableæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
$(MEMTABLE_TEST): $(LSM_OBJECTS) lsm_memtable_test.o
	@if [ -f "lsm_memtable_test.c" ]; then \
		echo "ğŸ”— é“¾æ¥ $@..."; \
		$(CC) $(CFLAGS) -o $@ $^ $(LIBS); \
		echo "âœ… æ„å»ºå®Œæˆ: $@"; \
	else \
		echo "â„¹ï¸  lsm_memtable_test.c ä¸å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"; \
	fi

# æ„å»ºSSTableæµ‹è¯•
$(SSTABLE_TEST): $(LSM_OBJECTS) lsm_sstable_test.o
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# ç¼–è¯‘è§„åˆ™
%.o: $(KVSERVER_SRC)/%.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# è¿è¡Œç®¡ç†å™¨æµ‹è¯•
test_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableç®¡ç†å™¨æµ‹è¯•..."
	@echo "=================================="
	./$(MEMTABLE_MANAGER_TEST)

# è¿è¡ŒMemTableæµ‹è¯•
test_memtable: $(MEMTABLE_TEST)
	@if [ -f "$(MEMTABLE_TEST)" ]; then \
		echo "ğŸ§ª è¿è¡ŒLSM-Tree MemTableæµ‹è¯•..."; \
		echo "=============================="; \
		./$(MEMTABLE_TEST); \
	else \
		echo "â„¹ï¸  MemTableæµ‹è¯•ç¨‹åºä¸å­˜åœ¨"; \
	fi

# è¿è¡ŒSSTableæµ‹è¯•
test_sstable: $(SSTABLE_TEST)
	@echo "ğŸ§ª è¿è¡ŒLSM-Tree SSTableæµ‹è¯•..."
	@echo "============================="
	./$(SSTABLE_TEST)

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test_manager test_memtable test_sstable
	@echo ""
	@echo "ğŸ‰ LSM-Treeæ‰€æœ‰æµ‹è¯•å®Œæˆ!"

# å†…å­˜æ£€æŸ¥
memcheck_manager: $(MEMTABLE_MANAGER_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥ï¼ˆç®¡ç†å™¨ï¼‰..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(MEMTABLE_MANAGER_TEST)

memcheck_sstable: $(SSTABLE_TEST)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥ï¼ˆSSTableï¼‰..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$(SSTABLE_TEST)

memcheck: memcheck_manager memcheck_sstable
	@echo "ğŸ‰ æ‰€æœ‰å†…å­˜æ£€æŸ¥å®Œæˆ!"

# æ€§èƒ½æµ‹è¯•
perf_test: $(MEMTABLE_MANAGER_TEST) $(SSTABLE_TEST)
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@echo "=================="
	@echo "MemTableç®¡ç†å™¨æ€§èƒ½:"
	time ./$(MEMTABLE_MANAGER_TEST)
	@echo ""
	@echo "SSTableæ€§èƒ½:"
	time ./$(SSTABLE_TEST)

# å‹åŠ›æµ‹è¯•
stress_test: $(MEMTABLE_MANAGER_TEST) $(SSTABLE_TEST)
	@echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•ï¼ˆå¤šæ¬¡æ‰§è¡Œï¼‰..."
	@echo "=============================="
	@echo "ç®¡ç†å™¨å‹åŠ›æµ‹è¯•:"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(MEMTABLE_MANAGER_TEST) || exit 1; \
		echo ""; \
	done
	@echo "SSTableå‹åŠ›æµ‹è¯•:"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iæ¬¡æµ‹è¯•:"; \
		./$(SSTABLE_TEST) || exit 1; \
		echo ""; \
	done
	@echo "âœ… å‹åŠ›æµ‹è¯•å…¨éƒ¨é€šè¿‡!"

# å¿«é€Ÿæµ‹è¯•ï¼ˆåªè¿è¡ŒSSTableï¼‰
quick_test: $(SSTABLE_TEST)
	@echo "ğŸš€ å¿«é€ŸSSTableæµ‹è¯•..."
	@echo "==================="
	./$(SSTABLE_TEST)

# ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
production_test: $(SSTABLE_TEST)
	@echo "ğŸ­ ç”Ÿäº§ç¯å¢ƒSSTableæµ‹è¯•..."
	@echo "========================"
	@echo "è¿è¡Œå…¨é¢çš„SSTableåŠŸèƒ½éªŒè¯..."
	./$(SSTABLE_TEST)
	@echo ""
	@echo "æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥..."
	@ls -la /tmp/test_*.sst 2>/dev/null || echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒæµ‹è¯•å®Œæˆ"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f *.o $(MEMTABLE_MANAGER_TEST) $(MEMTABLE_TEST) $(SSTABLE_TEST)
	rm -f /tmp/test_*.sst
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "LSM-Tree MemTableå’ŒSSTableæµ‹è¯•Makefileä½¿ç”¨è¯´æ˜"
	@echo "==============================================="
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all                    - æ„å»ºæ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_MANAGER_TEST)  - æ„å»ºç®¡ç†å™¨æµ‹è¯•ç¨‹åº"
	@echo "  $(MEMTABLE_TEST)       - æ„å»ºMemTableæµ‹è¯•ç¨‹åº"
	@echo "  $(SSTABLE_TEST)        - æ„å»ºSSTableæµ‹è¯•ç¨‹åº"
	@echo ""
	@echo "æµ‹è¯•ç›®æ ‡:"
	@echo "  test                   - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test_manager           - è¿è¡Œç®¡ç†å™¨æµ‹è¯•"
	@echo "  test_memtable          - è¿è¡ŒMemTableæµ‹è¯•"
	@echo "  test_sstable           - è¿è¡ŒSSTableæµ‹è¯•"
	@echo "  quick_test             - å¿«é€ŸSSTableæµ‹è¯•"
	@echo "  production_test        - ç”Ÿäº§ç¯å¢ƒæµ‹è¯•"
	@echo ""
	@echo "è°ƒè¯•ç›®æ ‡:"
	@echo "  memcheck               - è¿è¡Œæ‰€æœ‰Valgrindå†…å­˜æ£€æŸ¥"
	@echo "  memcheck_manager       - è¿è¡Œç®¡ç†å™¨å†…å­˜æ£€æŸ¥"
	@echo "  memcheck_sstable       - è¿è¡ŒSSTableå†…å­˜æ£€æŸ¥"
	@echo "  perf_test              - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  stress_test            - è¿è¡Œå‹åŠ›æµ‹è¯•"
	@echo ""
	@echo "ç»´æŠ¤ç›®æ ‡:"
	@echo "  clean                  - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  help                   - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make                   # æ„å»ºæ‰€æœ‰æµ‹è¯•"
	@echo "  make test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test_sstable      # åªè¿è¡ŒSSTableæµ‹è¯•"
	@echo "  make quick_test        # å¿«é€ŸSSTableæµ‹è¯•"
	@echo "  make memcheck_sstable  # SSTableå†…å­˜æ£€æŸ¥"
	@echo "  make clean             # æ¸…ç†"

# æ£€æŸ¥ä¾èµ–
check_deps:
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–æ–‡ä»¶..."
	@echo "LSMæºæ–‡ä»¶æ£€æŸ¥:"
	@for file in $(LSM_SOURCES); do \
		if [ -f "$$file" ]; then \
			echo "  âœ… $$file"; \
		else \
			echo "  âŒ $$file (ç¼ºå¤±)"; \
		fi \
	done
	@echo ""
	@echo "æµ‹è¯•æ–‡ä»¶æ£€æŸ¥:"
	@for file in $(TEST_SOURCES); do \
		if [ -f "$$file" ]; then \
			echo "  âœ… $$file"; \
		else \
			echo "  âŒ $$file (ç¼ºå¤±)"; \
		fi \
	done

# æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
info:
	@echo "LSM-Treeæµ‹è¯•ç¼–è¯‘ä¿¡æ¯"
	@echo "==================="
	@echo "ç¼–è¯‘å™¨: $(CC)"
	@echo "ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "åŒ…å«è·¯å¾„: $(INCLUDES)"
	@echo "é“¾æ¥åº“: $(LIBS)"
	@echo ""
	@echo "LSMæºæ–‡ä»¶:"
	@for file in $(LSM_SOURCES); do echo "  $$file"; done
	@echo ""
	@echo "æµ‹è¯•æ–‡ä»¶:"
	@for file in $(TEST_SOURCES); do echo "  $$file"; done

# ç¼–è¯‘æ£€æŸ¥
compile_check: 
	@echo "ğŸ”§ ç¼–è¯‘æ£€æŸ¥..."
	@echo "=============="
	@$(MAKE) clean
	@$(MAKE) check_deps
	@$(MAKE) all
	@echo "âœ… ç¼–è¯‘æ£€æŸ¥é€šè¿‡"

# åŠŸèƒ½è¦†ç›–ç‡æµ‹è¯•
coverage_test: $(SSTABLE_TEST)
	@echo "ğŸ“Š SSTableåŠŸèƒ½è¦†ç›–ç‡æµ‹è¯•..."
	@echo "==========================="
	@echo "æµ‹è¯•CRC32æ ¡éªŒå’Œ..."
	@./$(SSTABLE_TEST) | grep -q "CRC32" && echo "âœ… CRC32æµ‹è¯•é€šè¿‡"
	@echo "æµ‹è¯•å¸ƒéš†è¿‡æ»¤å™¨..."
	@./$(SSTABLE_TEST) | grep -q "å¸ƒéš†è¿‡æ»¤å™¨" && echo "âœ… å¸ƒéš†è¿‡æ»¤å™¨æµ‹è¯•é€šè¿‡"
	@echo "æµ‹è¯•æ•°æ®å—..."
	@./$(SSTABLE_TEST) | grep -q "æ•°æ®å—" && echo "âœ… æ•°æ®å—æµ‹è¯•é€šè¿‡"
	@echo "æµ‹è¯•ç´¢å¼•å—..."
	@./$(SSTABLE_TEST) | grep -q "ç´¢å¼•å—" && echo "âœ… ç´¢å¼•å—æµ‹è¯•é€šè¿‡"
	@echo "æµ‹è¯•å†™å…¥å™¨..."
	@./$(SSTABLE_TEST) | grep -q "å†™å…¥å™¨" && echo "âœ… å†™å…¥å™¨æµ‹è¯•é€šè¿‡"
	@echo "âœ… åŠŸèƒ½è¦†ç›–ç‡æµ‹è¯•å®Œæˆ"

.SUFFIXES: .c .o 