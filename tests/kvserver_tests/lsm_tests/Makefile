# LSM-Treeå®Œæ•´æµ‹è¯•å¥—ä»¶Makefile
# @Author: Lzww0608  
# @Date: 2025-6-3 15:30:00
# @LastEditTime: 2025-6-3 22:23:12

# ç¼–è¯‘å™¨è®¾ç½®
CC = gcc
CFLAGS = -Wall -Wextra -std=c11 -D_GNU_SOURCE -g -O2
INCLUDES = -I../../../kvserver
LDFLAGS = -lpthread -lz -lm

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_SRC = ../../../kvserver

# LSMç›¸å…³æºæ–‡ä»¶
LSM_SOURCES = $(KVSERVER_SRC)/lsm_memtable.c \
              $(KVSERVER_SRC)/lsm_memtable_manager.c \
              $(KVSERVER_SRC)/lsm_sstable.c \
              $(KVSERVER_SRC)/lsm_compaction.c \
              $(KVSERVER_SRC)/lsm_tree.c \
              $(KVSERVER_SRC)/kv_memory.c \
              $(KVSERVER_SRC)/kv_error.c

# ç›®æ ‡æ–‡ä»¶
LSM_OBJECTS = lsm_memtable.o lsm_memtable_manager.o lsm_sstable.o lsm_compaction.o lsm_tree.o kv_memory.o kv_error.o

# æµ‹è¯•ç¨‹åº
TESTS = lsm_memtable_test lsm_sstable_test lsm_memtable_manager_test lsm_compaction_test lsm_tree_test lsm_multithread_compaction_test lsm_multithread_performance_test lsm_batch_write_test

# æ ¸å¿ƒæµ‹è¯•ï¼ˆä¸åŒ…æ‹¬é›†æˆæµ‹è¯•ï¼‰
CORE_TESTS = lsm_memtable_test lsm_sstable_test lsm_memtable_manager_test lsm_compaction_test

# å¤šçº¿ç¨‹æµ‹è¯•
MULTITHREAD_TESTS = lsm_multithread_compaction_test lsm_multithread_performance_test

# é›†æˆæµ‹è¯•
INTEGRATION_TESTS = lsm_tree_test

# æ‰¹é‡å†™å…¥æµ‹è¯•
BATCH_TESTS = lsm_batch_write_test

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test test-core test-integration test-all memcheck help

all: $(TESTS)

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶è§„åˆ™
%.o: $(KVSERVER_SRC)/%.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ç¼–è¯‘æµ‹è¯•æ–‡ä»¶è§„åˆ™
%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# MemTableæµ‹è¯•
lsm_memtable_test: lsm_memtable_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_memtable_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# MemTableç®¡ç†å™¨æµ‹è¯•
lsm_memtable_manager_test: lsm_memtable_manager_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_memtable_manager_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# SSTableæµ‹è¯•
lsm_sstable_test: lsm_sstable_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_sstable_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# å‹ç¼©æœºåˆ¶æµ‹è¯•
lsm_compaction_test: lsm_compaction_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_compaction_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# LSM-Treeå®Œæ•´é›†æˆæµ‹è¯•
lsm_tree_test: lsm_tree_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_tree_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# å¤šçº¿ç¨‹å‹ç¼©æµ‹è¯•
lsm_multithread_compaction_test: lsm_multithread_compaction_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_multithread_compaction_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# å¤šçº¿ç¨‹å‹ç¼©æ€§èƒ½æµ‹è¯•
lsm_multithread_performance_test: lsm_multithread_performance_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_multithread_performance_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# æ‰¹é‡å†™å…¥æµ‹è¯•
lsm_batch_write_test: lsm_batch_write_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) lsm_batch_write_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# è°ƒè¯•æ‰¹é‡å†™å…¥æµ‹è¯•
debug_batch_test: debug_batch_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) debug_batch_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# è°ƒè¯•å»é‡åŠŸèƒ½æµ‹è¯•
debug_dedup_test: debug_dedup_test.c $(LSM_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) $(INCLUDES) debug_dedup_test.c $(LSM_OBJECTS) -o $@ $(LDFLAGS)
	@echo "âœ… æ„å»ºå®Œæˆ: $@"

# === æµ‹è¯•è¿è¡Œç›®æ ‡ ===

# è¿è¡Œæ ¸å¿ƒç»„ä»¶æµ‹è¯•
test-core: $(CORE_TESTS)
	@echo "ğŸš€ è¿è¡ŒLSM-Treeæ ¸å¿ƒç»„ä»¶æµ‹è¯•..."
	@echo "=================================="
	@for test in $(CORE_TESTS); do \
		echo ""; \
		echo "ğŸ§ª è¿è¡Œ $$test..."; \
		echo "----------------------------------------"; \
		./$$test || exit 1; \
	done
	@echo ""
	@echo "ğŸ‰ æ ¸å¿ƒç»„ä»¶æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# è¿è¡Œå¤šçº¿ç¨‹æµ‹è¯•
test-multithread: $(MULTITHREAD_TESTS)
	@echo "ğŸš€ è¿è¡ŒLSM-Treeå¤šçº¿ç¨‹å‹ç¼©æµ‹è¯•..."
	@echo "=================================="
	@for test in $(MULTITHREAD_TESTS); do \
		echo ""; \
		echo "ğŸ§ª è¿è¡Œ $$test..."; \
		echo "----------------------------------------"; \
		./$$test || exit 1; \
	done
	@echo ""
	@echo "ğŸ‰ å¤šçº¿ç¨‹æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# è¿è¡Œé›†æˆæµ‹è¯•
test-integration: $(INTEGRATION_TESTS)
	@echo "ğŸš€ è¿è¡ŒLSM-Treeå®Œæ•´é›†æˆæµ‹è¯•..."
	@echo "================================"
	@for test in $(INTEGRATION_TESTS); do \
		echo ""; \
		echo "ğŸ§ª è¿è¡Œ $$test..."; \
		echo "----------------------------------------"; \
		./$$test || exit 1; \
	done
	@echo ""
	@echo "ğŸ‰ é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# è¿è¡Œæ‰¹é‡å†™å…¥æµ‹è¯•
test-batch: $(BATCH_TESTS)
	@echo "ğŸš€ è¿è¡ŒLSM-Treeæ‰¹é‡å†™å…¥åŠŸèƒ½æµ‹è¯•..."
	@echo "=================================="
	@for test in $(BATCH_TESTS); do \
		echo ""; \
		echo "ğŸ§ª è¿è¡Œ $$test..."; \
		echo "----------------------------------------"; \
		./$$test || exit 1; \
	done
	@echo ""
	@echo "ğŸ‰ æ‰¹é‡å†™å…¥æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test-all: $(TESTS)
	@echo "ğŸš€ è¿è¡ŒLSM-Treeå®Œæ•´æµ‹è¯•å¥—ä»¶..."
	@echo "==============================="
	@echo "åŒ…å«æµ‹è¯•ï¼š"
	@for test in $(TESTS); do echo "  - $$test"; done
	@echo ""
	@for test in $(TESTS); do \
		echo "ğŸ§ª è¿è¡Œ $$test..."; \
		echo "----------------------------------------"; \
		./$$test || exit 1; \
		echo ""; \
	done
	@echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# ä¿æŒå‘åå…¼å®¹çš„testç›®æ ‡
test: test-core

# === è´¨é‡æ£€æŸ¥ç›®æ ‡ ===

# å†…å­˜æ£€æŸ¥
memcheck: $(TESTS)
	@echo "ğŸ” è¿è¡ŒValgrindå†…å­˜æ£€æŸ¥..."
	@echo "=========================="
	@for test in $(TESTS); do \
		echo ""; \
		echo "ğŸ” å†…å­˜æ£€æŸ¥: $$test"; \
		echo "----------------------------------------"; \
		valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./$$test || exit 1; \
	done
	@echo ""
	@echo "ğŸ‰ å†…å­˜æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼"

# æ€§èƒ½åŸºå‡†æµ‹è¯•
perf: $(TESTS)
	@echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@echo "====================="
	@for test in $(TESTS); do \
		echo ""; \
		echo "âš¡ æ€§èƒ½æµ‹è¯•: $$test"; \
		echo "----------------------------------------"; \
		time ./$$test; \
	done
	@echo ""
	@echo "ğŸ‰ æ€§èƒ½æµ‹è¯•å®Œæˆï¼"

# å‹åŠ›æµ‹è¯•ï¼ˆå¤šæ¬¡è¿è¡Œï¼‰
stress: $(TESTS)
	@echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•ï¼ˆæ¯ä¸ªæµ‹è¯•3æ¬¡ï¼‰..."
	@echo "================================="
	@for test in $(TESTS); do \
		echo ""; \
		echo "ğŸ’ª å‹åŠ›æµ‹è¯•: $$test"; \
		echo "----------------------------------------"; \
		for i in 1 2 3; do \
			echo "ç¬¬$$iæ¬¡è¿è¡Œ:"; \
			./$$test || exit 1; \
		done; \
	done
	@echo ""
	@echo "ğŸ‰ å‹åŠ›æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"

# === ç»´æŠ¤ç›®æ ‡ ===

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶å’Œæµ‹è¯•æ•°æ®..."
	rm -f $(LSM_OBJECTS) $(TESTS)
	rm -rf test_lsm_* ./lsm_data ./test_* *.log *.tmp
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ç¼–è¾‘å™¨ä¸´æ—¶æ–‡ä»¶ç­‰ï¼‰
distclean: clean
	@echo "ğŸ§¹ æ·±åº¦æ¸…ç†..."
	find . -name "*~" -delete
	find . -name "*.swp" -delete
	find . -name "*.bak" -delete
	find . -name "core" -delete
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
check-sources:
	@echo "ğŸ” æ£€æŸ¥æºæ–‡ä»¶å®Œæ•´æ€§..."
	@for src in $(LSM_SOURCES); do \
		if [ ! -f "$$src" ]; then \
			echo "âŒ ç¼ºå°‘æºæ–‡ä»¶: $$src"; \
			exit 1; \
		else \
			echo "âœ… æ‰¾åˆ°: $$src"; \
		fi; \
	done
	@echo "ğŸ‰ æ‰€æœ‰æºæ–‡ä»¶å®Œæ•´ï¼"

# æ„å»ºçŠ¶æ€æ£€æŸ¥
status:
	@echo "ğŸ“Š æ„å»ºçŠ¶æ€ï¼š"
	@echo "============="
	@echo "å·²æ„å»ºçš„æµ‹è¯•ç¨‹åºï¼š"
	@for test in $(TESTS); do \
		if [ -f "$$test" ]; then \
			echo "  âœ… $$test"; \
		else \
			echo "  âŒ $$test (æœªæ„å»º)"; \
		fi; \
	done
	@echo ""
	@echo "ç›®æ ‡æ–‡ä»¶ï¼š"
	@for obj in $(LSM_OBJECTS); do \
		if [ -f "$$obj" ]; then \
			echo "  âœ… $$obj"; \
		else \
			echo "  âŒ $$obj (æœªç¼–è¯‘)"; \
		fi; \
	done

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "LSM-Treeå®Œæ•´æµ‹è¯•å¥—ä»¶ Makefile"
	@echo "=============================="
	@echo ""
	@echo "ğŸ¯ ä¸»è¦ç›®æ ‡ï¼š"
	@echo "  all              - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  test-core        - è¿è¡Œæ ¸å¿ƒç»„ä»¶æµ‹è¯•"
	@echo "  test-integration - è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•"
	@echo "  test-all         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test             - è¿è¡Œæ ¸å¿ƒæµ‹è¯•ï¼ˆå‘åå…¼å®¹ï¼‰"
	@echo ""
	@echo "ğŸ” è´¨é‡æ£€æŸ¥ï¼š"
	@echo "  memcheck         - Valgrindå†…å­˜æ£€æŸ¥"
	@echo "  perf             - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  stress           - å‹åŠ›æµ‹è¯•ï¼ˆå¤šæ¬¡è¿è¡Œï¼‰"
	@echo ""
	@echo "ğŸ§¹ ç»´æŠ¤ç›®æ ‡ï¼š"
	@echo "  clean            - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  distclean        - æ·±åº¦æ¸…ç†"
	@echo "  check-sources    - æ£€æŸ¥æºæ–‡ä»¶å®Œæ•´æ€§"
	@echo "  status           - æ˜¾ç¤ºæ„å»ºçŠ¶æ€"
	@echo "  help             - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ğŸ“‹ æµ‹è¯•ç¨‹åºåˆ—è¡¨ï¼š"
	@echo "  æ ¸å¿ƒæµ‹è¯•: $(CORE_TESTS)"
	@echo "  é›†æˆæµ‹è¯•: $(INTEGRATION_TESTS)"
	@echo ""
	@echo "ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹ï¼š"
	@echo "  make all && make test-all    # ç¼–è¯‘å¹¶è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-integration        # åªè¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  make memcheck               # å†…å­˜æ£€æŸ¥"

# åŒ…å«ä¾èµ–å…³ç³»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
-include *.d 