# ConcordKV LSM-Tree ä¼˜åŒ–å¸ƒéš†è¿‡æ»¤å™¨æµ‹è¯• Makefile
# Author: Lzww0608
# Date: 2025-6-5 21:30:00

# === ç¼–è¯‘å™¨é…ç½® ===
CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -g -O2 -fPIC -pthread
CFLAGS_DEBUG = -std=c99 -Wall -Wextra -g -O0 -fPIC -pthread -DDEBUG
CFLAGS_RELEASE = -std=c99 -Wall -Wextra -O3 -DNDEBUG -fPIC -pthread -march=native

# === è·¯å¾„é…ç½® ===
KVSERVER_DIR = ../../../kvserver
UTILS_DIR = ../../../utils
COMMON_DIR = ../../../common

# === åŒ…å«è·¯å¾„ ===
INCLUDES = -I$(KVSERVER_DIR) -I$(UTILS_DIR) -I$(COMMON_DIR) -I../../../

# === åº“é…ç½® ===
LIBS = -lm -lpthread -lrt

# === æºæ–‡ä»¶ ===
TEST_SOURCES = lsm_bloom_filter_optimized_test.c
BLOOM_SOURCES = $(KVSERVER_DIR)/lsm_bloom_filter_optimized.c
MEMORY_SOURCES = $(KVSERVER_DIR)/kv_memory.c
ERROR_SOURCES = $(KVSERVER_DIR)/kv_error.c

# === å¯¹è±¡æ–‡ä»¶ ===
TEST_OBJECTS = $(TEST_SOURCES:.c=.o)
BLOOM_OBJECTS = $(BLOOM_SOURCES:.c=.o)
MEMORY_OBJECTS = $(MEMORY_SOURCES:.c=.o)
ERROR_OBJECTS = $(ERROR_SOURCES:.c=.o)

ALL_OBJECTS = $(TEST_OBJECTS) $(BLOOM_OBJECTS) $(MEMORY_OBJECTS) $(ERROR_OBJECTS)

# === å¯æ‰§è¡Œæ–‡ä»¶ ===
TEST_EXECUTABLE = lsm_bloom_filter_optimized_test
TEST_EXECUTABLE_DEBUG = $(TEST_EXECUTABLE)_debug
TEST_EXECUTABLE_RELEASE = $(TEST_EXECUTABLE)_release

# === é»˜è®¤ç›®æ ‡ ===
.PHONY: all clean test test-debug test-release benchmark valgrind help

all: $(TEST_EXECUTABLE)

# === ç¼–è¯‘ç›®æ ‡ ===
$(TEST_EXECUTABLE): $(ALL_OBJECTS)
	@echo "ğŸ”— é“¾æ¥ $@..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $@"

# === è°ƒè¯•ç‰ˆæœ¬ ===
debug: $(TEST_EXECUTABLE_DEBUG)

$(TEST_EXECUTABLE_DEBUG): CFLAGS := $(CFLAGS_DEBUG)
$(TEST_EXECUTABLE_DEBUG): $(ALL_OBJECTS)
	@echo "ğŸ”— é“¾æ¥è°ƒè¯•ç‰ˆæœ¬ $@..."
	$(CC) $(CFLAGS_DEBUG) -o $@ $^ $(LIBS)
	@echo "âœ… è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ: $@"

# === å‘å¸ƒç‰ˆæœ¬ ===
release: $(TEST_EXECUTABLE_RELEASE)

$(TEST_EXECUTABLE_RELEASE): CFLAGS := $(CFLAGS_RELEASE)
$(TEST_EXECUTABLE_RELEASE): $(ALL_OBJECTS)
	@echo "ğŸ”— é“¾æ¥å‘å¸ƒç‰ˆæœ¬ $@..."
	$(CC) $(CFLAGS_RELEASE) -o $@ $^ $(LIBS)
	@echo "âœ… å‘å¸ƒç‰ˆæœ¬ç¼–è¯‘å®Œæˆ: $@"

# === å¯¹è±¡æ–‡ä»¶ç¼–è¯‘è§„åˆ™ ===
%.o: %.c
	@echo "ğŸ“¦ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ç‰¹æ®Šå¤„ç†kvserverç›®å½•ä¸‹çš„æºæ–‡ä»¶
$(KVSERVER_DIR)/%.o: $(KVSERVER_DIR)/%.c
	@echo "ğŸ“¦ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# === æµ‹è¯•ç›®æ ‡ ===
test: $(TEST_EXECUTABLE)
	@echo "ğŸ§ª è¿è¡Œå¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–æµ‹è¯•..."
	@echo "========================================"
	./$(TEST_EXECUTABLE)
	@echo "========================================"
	@echo "âœ… æµ‹è¯•å®Œæˆ"

test-debug: $(TEST_EXECUTABLE_DEBUG)
	@echo "ğŸ› è¿è¡Œå¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–è°ƒè¯•æµ‹è¯•..."
	@echo "========================================"
	./$(TEST_EXECUTABLE_DEBUG)
	@echo "========================================"
	@echo "âœ… è°ƒè¯•æµ‹è¯•å®Œæˆ"

test-release: $(TEST_EXECUTABLE_RELEASE)
	@echo "ğŸš€ è¿è¡Œå¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–å‘å¸ƒæµ‹è¯•..."
	@echo "========================================"
	./$(TEST_EXECUTABLE_RELEASE)
	@echo "========================================"
	@echo "âœ… å‘å¸ƒæµ‹è¯•å®Œæˆ"

# === æ€§èƒ½åŸºå‡†æµ‹è¯• ===
benchmark: $(TEST_EXECUTABLE_RELEASE)
	@echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@echo "========================================"
	time ./$(TEST_EXECUTABLE_RELEASE)
	@echo "========================================"
	@echo "âœ… åŸºå‡†æµ‹è¯•å®Œæˆ"

# === å†…å­˜æ£€æŸ¥ ===
valgrind: $(TEST_EXECUTABLE_DEBUG)
	@echo "ğŸ” è¿è¡Œå†…å­˜æ£€æŸ¥..."
	@echo "========================================"
	valgrind --tool=memcheck \
		--leak-check=full \
		--show-leak-kinds=all \
		--track-origins=yes \
		--verbose \
		--log-file=valgrind_bloom_optimized.log \
		./$(TEST_EXECUTABLE_DEBUG)
	@echo "========================================"
	@echo "âœ… å†…å­˜æ£€æŸ¥å®Œæˆï¼Œç»“æœä¿å­˜åˆ° valgrind_bloom_optimized.log"

# === ä»£ç è¦†ç›–ç‡ ===
coverage: CFLAGS += --coverage
coverage: LIBS += -lgcov
coverage: $(TEST_EXECUTABLE)
	@echo "ğŸ“Š è¿è¡Œä»£ç è¦†ç›–ç‡æµ‹è¯•..."
	./$(TEST_EXECUTABLE)
	gcov $(BLOOM_SOURCES)
	@echo "âœ… ä»£ç è¦†ç›–ç‡æµ‹è¯•å®Œæˆ"

# === é™æ€åˆ†æ ===
static-analysis:
	@echo "ğŸ” è¿è¡Œé™æ€ä»£ç åˆ†æ..."
	@which cppcheck > /dev/null 2>&1 || (echo "âŒ è¯·å®‰è£… cppcheck"; exit 1)
	cppcheck --enable=all --std=c99 --platform=unix64 \
		--suppress=missingIncludeSystem \
		--suppress=unusedFunction \
		--suppress=unmatchedSuppression \
		$(INCLUDES) \
		$(TEST_SOURCES) $(BLOOM_SOURCES)
	@echo "âœ… é™æ€åˆ†æå®Œæˆ"

# === æ€§èƒ½åˆ†æ ===
profile: CFLAGS += -pg
profile: $(TEST_EXECUTABLE)
	@echo "ğŸ“ˆ è¿è¡Œæ€§èƒ½åˆ†æ..."
	./$(TEST_EXECUTABLE)
	gprof $(TEST_EXECUTABLE) gmon.out > profile_bloom_optimized.txt
	@echo "âœ… æ€§èƒ½åˆ†æå®Œæˆï¼Œç»“æœä¿å­˜åˆ° profile_bloom_optimized.txt"

# === å¹¶è¡Œæµ‹è¯• ===
test-parallel: $(TEST_EXECUTABLE)
	@echo "ğŸ”„ è¿è¡Œå¹¶è¡Œæµ‹è¯•..."
	@for i in 1 2 3 4; do \
		echo "è¿è¡Œæµ‹è¯•å®ä¾‹ $$i..."; \
		./$(TEST_EXECUTABLE) & \
	done; \
	wait
	@echo "âœ… å¹¶è¡Œæµ‹è¯•å®Œæˆ"

# === å‹åŠ›æµ‹è¯• ===
stress-test: $(TEST_EXECUTABLE_RELEASE)
	@echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•..."
	@for i in 1 2 3 4 5; do \
		echo "å‹åŠ›æµ‹è¯•è½®æ¬¡ $$i/5..."; \
		timeout 60 ./$(TEST_EXECUTABLE_RELEASE) || true; \
	done
	@echo "âœ… å‹åŠ›æµ‹è¯•å®Œæˆ"

# === æ¸…ç†ç›®æ ‡ ===
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(ALL_OBJECTS)
	rm -f $(TEST_EXECUTABLE) $(TEST_EXECUTABLE_DEBUG) $(TEST_EXECUTABLE_RELEASE)
	rm -f *.gcov *.gcda *.gcno gmon.out
	rm -f valgrind_bloom_optimized.log profile_bloom_optimized.txt
	rm -f core core.*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# === å®‰è£…ä¾èµ– ===
install-deps:
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–..."
	@which valgrind > /dev/null 2>&1 || sudo apt-get install -y valgrind
	@which cppcheck > /dev/null 2>&1 || sudo apt-get install -y cppcheck
	@which gcov > /dev/null 2>&1 || sudo apt-get install -y gcc
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# === Dockeræµ‹è¯• ===
docker-test:
	@echo "ğŸ³ åœ¨Dockerä¸­è¿è¡Œæµ‹è¯•..."
	docker run --rm -v $(PWD)/../../..:/workspace -w /workspace/tests/kvserver_tests/lsm_tests \
		gcc:latest make -f Makefile_bloom_optimized test
	@echo "âœ… Dockeræµ‹è¯•å®Œæˆ"

# === æ£€æŸ¥æ„å»ºç¯å¢ƒ ===
check-env:
	@echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ..."
	@echo "ç¼–è¯‘å™¨: $(shell $(CC) --version | head -n1)"
	@echo "Makeç‰ˆæœ¬: $(shell make --version | head -n1)"
	@echo "ç³»ç»Ÿ: $(shell uname -a)"
	@echo "CPUä¿¡æ¯: $(shell cat /proc/cpuinfo | grep 'model name' | head -n1 | cut -d: -f2)"
	@echo "å†…å­˜ä¿¡æ¯: $(shell free -h | grep '^Mem' | awk '{print $$2}')"
	@echo "ç£ç›˜ç©ºé—´: $(shell df -h . | tail -n1 | awk '{print $$4}')"
	@echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# === è‡ªåŠ¨åŒ–æµ‹è¯• ===
auto-test: clean all test coverage valgrind
	@echo "ğŸ¤– è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ"

# === å¿«é€Ÿæµ‹è¯• ===
quick-test: $(TEST_EXECUTABLE)
	@echo "âš¡ å¿«é€Ÿæµ‹è¯•..."
	timeout 30 ./$(TEST_EXECUTABLE)

# === å¸®åŠ©ä¿¡æ¯ ===
help:
	@echo "ğŸ”§ ConcordKV LSM-Tree ä¼˜åŒ–å¸ƒéš†è¿‡æ»¤å™¨æµ‹è¯• Makefile"
	@echo "=================================================="
	@echo ""
	@echo "ç¼–è¯‘ç›®æ ‡:"
	@echo "  all              - ç¼–è¯‘æµ‹è¯•ç¨‹åº(é»˜è®¤)"
	@echo "  debug            - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  release          - ç¼–è¯‘ä¼˜åŒ–ç‰ˆæœ¬"
	@echo ""
	@echo "æµ‹è¯•ç›®æ ‡:"
	@echo "  test             - è¿è¡ŒåŸºç¡€æµ‹è¯•"
	@echo "  test-debug       - è¿è¡Œè°ƒè¯•æµ‹è¯•"
	@echo "  test-release     - è¿è¡Œå‘å¸ƒæµ‹è¯•"
	@echo "  quick-test       - å¿«é€Ÿæµ‹è¯•(30ç§’è¶…æ—¶)"
	@echo "  test-parallel    - å¹¶è¡Œæµ‹è¯•"
	@echo "  stress-test      - å‹åŠ›æµ‹è¯•"
	@echo ""
	@echo "åˆ†æç›®æ ‡:"
	@echo "  benchmark        - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  valgrind         - å†…å­˜æ£€æŸ¥"
	@echo "  coverage         - ä»£ç è¦†ç›–ç‡"
	@echo "  static-analysis  - é™æ€ä»£ç åˆ†æ"
	@echo "  profile          - æ€§èƒ½åˆ†æ"
	@echo ""
	@echo "ç»´æŠ¤ç›®æ ‡:"
	@echo "  clean            - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  install-deps     - å®‰è£…ä¾èµ–"
	@echo "  check-env        - æ£€æŸ¥æ„å»ºç¯å¢ƒ"
	@echo "  auto-test        - è‡ªåŠ¨åŒ–æµ‹è¯•"
	@echo "  docker-test      - Dockeræµ‹è¯•"
	@echo "  help             - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"

# === ä¾èµ–å…³ç³» ===
$(TEST_OBJECTS): $(TEST_SOURCES)
$(BLOOM_OBJECTS): $(BLOOM_SOURCES) $(KVSERVER_DIR)/lsm_bloom_filter_optimized.h
$(MEMORY_OBJECTS): $(MEMORY_SOURCES) $(KVSERVER_DIR)/kv_memory.h
$(ERROR_OBJECTS): $(ERROR_SOURCES) $(KVSERVER_DIR)/kv_error.h 