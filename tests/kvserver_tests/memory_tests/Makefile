# ConcordKV Arenaå†…å­˜æ± æµ‹è¯• Makefile
# @Author: Lzww0608
# @Date: 2025-01-08 14:45:00
# @LastEditors: Lzww0608
# @LastEditTime: 2025-01-08 16:45:00
# @Description: Arenaå†…å­˜æ± æµ‹è¯•æ„å»ºè„šæœ¬

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g -O2 -D_GNU_SOURCE -D_POSIX_C_SOURCE=200809L
LDFLAGS = -lpthread

# æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒNUMA
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†libnuma
    NUMA_CHECK := $(shell pkg-config --exists libnuma && echo "yes" || echo "no")
    ifeq ($(NUMA_CHECK),yes)
        CFLAGS += -DHAVE_NUMA
        LDFLAGS += -lnuma
    endif
endif

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_DIR = ../../../kvserver
MEMORY_SRC = $(KVSERVER_DIR)/kv_memory.c
MEMORY_HDR = $(KVSERVER_DIR)/kv_memory.h

# æµ‹è¯•æ–‡ä»¶
TEST_BASIC = test_arena_memory.c
TEST_ENHANCED = test_arena_memory_enhanced.c

# ç›®æ ‡æ–‡ä»¶
TARGET_BASIC = test_arena_memory
TARGET_ENHANCED = test_arena_memory_enhanced
TARGET_BLOCK_DEMO = block_size_performance_demo
TARGET_DEBUG = debug_test_runner
TARGET_QUICK = quick_perf_test
TARGET_INTEGRATION = kv_memory_integration_test

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test test-basic test-enhanced benchmark valgrind help

all: $(TARGET_BASIC) $(TARGET_ENHANCED) $(TARGET_BLOCK_DEMO) $(TARGET_DEBUG) $(TARGET_QUICK) $(TARGET_INTEGRATION)

# ç¼–è¯‘åŸºç¡€ç‰ˆæµ‹è¯•
$(TARGET_BASIC): $(TEST_BASIC) $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘åŸºç¡€ç‰ˆArenaå†…å­˜æ± æµ‹è¯•..."
	$(CC) $(CFLAGS) -o $@ $(TEST_BASIC) $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… åŸºç¡€ç‰ˆæµ‹è¯•ç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘å¢å¼ºç‰ˆæµ‹è¯•
$(TARGET_ENHANCED): $(TEST_ENHANCED) $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘å¢å¼ºç‰ˆArenaå†…å­˜æ± æµ‹è¯•..."
	$(CC) $(CFLAGS) -o $@ $(TEST_ENHANCED) $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… å¢å¼ºç‰ˆæµ‹è¯•ç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘å—å¤§å°æ€§èƒ½æ¼”ç¤º
$(TARGET_BLOCK_DEMO): block_size_performance_demo.c $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘å—å¤§å°æ€§èƒ½æ¼”ç¤ºç¨‹åº..."
	$(CC) $(CFLAGS) -o $@ block_size_performance_demo.c $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… å—å¤§å°æ¼”ç¤ºç¨‹åºç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘è°ƒè¯•æµ‹è¯•
$(TARGET_DEBUG): debug_test_runner.c $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘è°ƒè¯•æµ‹è¯•ç¨‹åº..."
	$(CC) $(CFLAGS) -o $@ debug_test_runner.c $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… è°ƒè¯•æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘å¿«é€Ÿæ€§èƒ½æµ‹è¯•
$(TARGET_QUICK): quick_perf_test.c $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘å¿«é€Ÿæ€§èƒ½æµ‹è¯•ç¨‹åº..."
	$(CC) $(CFLAGS) -o $@ quick_perf_test.c $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… å¿«é€Ÿæ€§èƒ½æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘å†…å­˜æ± é›†æˆæµ‹è¯•
$(TARGET_INTEGRATION): kv_memory_integration_test.c $(MEMORY_SRC) $(MEMORY_HDR)
	@echo "ğŸ”¨ ç¼–è¯‘å†…å­˜æ± é›†æˆæµ‹è¯•ç¨‹åº..."
	$(CC) $(CFLAGS) -o $@ kv_memory_integration_test.c $(MEMORY_SRC) $(LDFLAGS)
	@echo "âœ… å†…å­˜æ± é›†æˆæµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"

# è¿è¡ŒåŸºç¡€ç‰ˆæµ‹è¯•
test-basic: $(TARGET_BASIC)
	@echo "ğŸ§ª è¿è¡ŒåŸºç¡€ç‰ˆArenaå†…å­˜æ± æµ‹è¯•..."
	@echo "========================================"
	./$(TARGET_BASIC)
	@echo ""

# è¿è¡Œå¢å¼ºç‰ˆæµ‹è¯•
test-enhanced: $(TARGET_ENHANCED)
	@echo "ğŸ§ª è¿è¡Œå¢å¼ºç‰ˆArenaå†…å­˜æ± æµ‹è¯•..."
	@echo "========================================"
	./$(TARGET_ENHANCED)
	@echo ""

# è¿è¡Œå—å¤§å°æ€§èƒ½æ¼”ç¤º
test-block-demo: $(TARGET_BLOCK_DEMO)
	@echo "ğŸ§ª è¿è¡Œå—å¤§å°æ€§èƒ½æ¼”ç¤º..."
	@echo "========================================"
	./$(TARGET_BLOCK_DEMO)
	@echo ""

# è¿è¡Œè°ƒè¯•æµ‹è¯•
debug: $(TARGET_DEBUG)
	@echo "ğŸ” è¿è¡Œè°ƒè¯•æµ‹è¯•..."
	@echo "========================================"
	./$(TARGET_DEBUG)
	@echo ""

# è¿è¡Œå¿«é€Ÿæ€§èƒ½æµ‹è¯•
quick: $(TARGET_QUICK)
	@echo "âš¡ è¿è¡Œå¿«é€Ÿæ€§èƒ½æµ‹è¯•..."
	@echo "========================================"
	./$(TARGET_QUICK)
	@echo ""

# è¿è¡Œå†…å­˜æ± é›†æˆæµ‹è¯•
test-integration: $(TARGET_INTEGRATION)
	@echo "ğŸ”— è¿è¡Œå†…å­˜æ± é›†æˆæµ‹è¯•..."
	@echo "========================================"
	./$(TARGET_INTEGRATION)
	@echo ""

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test-basic test-enhanced test-integration
	@echo "ğŸ‰ æ‰€æœ‰Arenaå†…å­˜æ± æµ‹è¯•å®Œæˆï¼"

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark: $(TARGET_ENHANCED)
	@echo "ğŸ“Š è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@echo "========================================"
	@echo "âš¡ åŸºç¡€æ€§èƒ½æµ‹è¯•:"
	./$(TARGET_ENHANCED) | grep -E "(æ€§èƒ½å¯¹æ¯”|å¹¶å‘æ€§èƒ½|Arenaåˆ†é…ç»Ÿè®¡)"
	@echo ""
	@echo "ğŸ”¥ å‹åŠ›æµ‹è¯• (å¤§é‡åˆ†é…):"
	@for i in 1 2 3; do \
		echo "ç¬¬$$iè½®æµ‹è¯•:"; \
		./$(TARGET_ENHANCED) | grep "æ€§èƒ½å¯¹æ¯”" || true; \
	done

# å†…å­˜æ³„æ¼æ£€æµ‹ (éœ€è¦å®‰è£…valgrind)
valgrind: $(TARGET_ENHANCED)
	@echo "ğŸ” è¿è¡Œå†…å­˜æ³„æ¼æ£€æµ‹..."
	@echo "========================================"
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
		--suppressions=/dev/null ./$(TARGET_ENHANCED); \
	else \
		echo "âŒ æœªå®‰è£…valgrindï¼Œè·³è¿‡å†…å­˜æ³„æ¼æ£€æµ‹"; \
		echo "ğŸ’¡ å®‰è£…å‘½ä»¤: sudo apt-get install valgrind"; \
	fi

# çº¿ç¨‹å®‰å…¨æµ‹è¯• (é«˜å¹¶å‘)
stress-test: $(TARGET_ENHANCED)
	@echo "ğŸ”¥ è¿è¡Œé«˜å¹¶å‘å‹åŠ›æµ‹è¯•..."
	@echo "========================================"
	@echo "æµ‹è¯•é…ç½®: å¤šçº¿ç¨‹é«˜å¹¶å‘åˆ†é…"
	@for threads in 4 8 16 32; do \
		echo "ğŸ§µ $$threads çº¿ç¨‹æµ‹è¯•:"; \
		timeout 30s ./$(TARGET_ENHANCED) || echo "æµ‹è¯•å®Œæˆæˆ–è¶…æ—¶"; \
		echo ""; \
	done

# æ€§èƒ½åˆ†æ (éœ€è¦å®‰è£…perf)
perf-analysis: $(TARGET_ENHANCED)
	@echo "ğŸ“ˆ è¿è¡Œæ€§èƒ½åˆ†æ..."
	@echo "========================================"
	@if command -v perf >/dev/null 2>&1; then \
		echo "ğŸ” CPUæ€§èƒ½åˆ†æ:"; \
		perf stat -e cycles,instructions,cache-misses,cache-references ./$(TARGET_ENHANCED); \
		echo ""; \
		echo "ğŸ” å†…å­˜è®¿é—®åˆ†æ:"; \
		perf stat -e L1-dcache-loads,L1-dcache-load-misses,LLC-loads,LLC-load-misses ./$(TARGET_ENHANCED); \
	else \
		echo "âŒ æœªå®‰è£…perfå·¥å…·ï¼Œè·³è¿‡æ€§èƒ½åˆ†æ"; \
		echo "ğŸ’¡ å®‰è£…å‘½ä»¤: sudo apt-get install linux-tools-generic"; \
	fi

# ç¼–è¯‘ä¿¡æ¯
info:
	@echo "ğŸ“‹ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯"
	@echo "========================================"
	@echo "ç¼–è¯‘å™¨: $(CC)"
	@echo "ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "é“¾æ¥é€‰é¡¹: $(LDFLAGS)"
	@echo "ç³»ç»Ÿ: $(UNAME_S)"
ifeq ($(UNAME_S),Linux)
	@echo "NUMAæ”¯æŒ: $(NUMA_CHECK)"
endif
	@echo "æºæ–‡ä»¶: $(MEMORY_SRC)"
	@echo "å¤´æ–‡ä»¶: $(MEMORY_HDR)"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(TARGET_BASIC) $(TARGET_ENHANCED) $(TARGET_BLOCK_DEMO) $(TARGET_DEBUG) $(TARGET_QUICK)
	rm -f *.o *.core core.*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸš€ ConcordKV Arenaå†…å­˜æ± æµ‹è¯•æ„å»ºç³»ç»Ÿ"
	@echo "========================================"
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  test-basic    - è¿è¡ŒåŸºç¡€ç‰ˆæµ‹è¯•"
	@echo "  test-enhanced - è¿è¡Œå¢å¼ºç‰ˆæµ‹è¯•"
	@echo "  test-block-demo - è¿è¡Œå—å¤§å°æ€§èƒ½æ¼”ç¤º"
	@echo "  test          - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  benchmark     - è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  stress-test   - è¿è¡Œé«˜å¹¶å‘å‹åŠ›æµ‹è¯•"
	@echo "  valgrind      - è¿è¡Œå†…å­˜æ³„æ¼æ£€æµ‹"
	@echo "  perf-analysis - è¿è¡Œæ€§èƒ½åˆ†æ"
	@echo "  info          - æ˜¾ç¤ºç¼–è¯‘ç¯å¢ƒä¿¡æ¯"
	@echo "  clean         - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ğŸ”§ ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make test           # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make benchmark      # æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  make valgrind       # å†…å­˜æ³„æ¼æ£€æµ‹"
	@echo "  make stress-test    # é«˜å¹¶å‘å‹åŠ›æµ‹è¯•" 