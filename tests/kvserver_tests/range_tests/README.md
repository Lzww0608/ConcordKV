# ConcordKV 范围查询和前缀扫描测试

## 概述

本目录包含 ConcordKV Phase 4.2 高级功能的范围查询和前缀扫描机制的综合测试套件。

## 功能特性

### 核心功能
- **范围查询**: 支持指定起始和结束键的范围扫描
- **前缀扫描**: 高效的前缀匹配查询
- **批量前缀查询**: 多前缀并行查询优化
- **迭代器支持**: 大数据集的流式处理
- **超时机制**: 防止死锁的安全保障

### 测试覆盖
- ✅ 基础范围查询功能验证
- ✅ 前缀匹配算法测试
- ✅ 批量查询性能测试
- ✅ 边界条件处理
- ✅ 超时机制验证
- ✅ 并发安全性测试
- ✅ 统计信息功能
- ✅ 内存泄漏检测

## 目录结构

```
range_tests/
├── test_range_query.c      # 主测试文件
├── Makefile                # 构建配置
├── README.md              # 本文档
└── build/                 # 构建输出目录
    ├── *.o               # 目标文件
    └── test_range_query   # 测试可执行文件
```

## 编译和运行

### 基础编译
```bash
make all
```

### 运行测试
```bash
make test
```

### 详细模式测试
```bash
make test-verbose
```

### 内存检查
```bash
make valgrind
```

### 清理构建文件
```bash
make clean
```

## 测试项目

### 1. 基础功能测试
验证核心API的正确性：
- 默认选项创建
- 前缀配置设置
- 工具函数验证

### 2. 范围查询测试
测试范围扫描功能：
- 包含/排除边界测试
- 结果排序验证
- 限制数量功能
- 查询性能监控

### 3. 前缀扫描测试
验证前缀匹配：
- 精确前缀匹配
- 大小写敏感性
- 结果过滤正确性
- 性能基准测试

### 4. 批量查询测试
多前缀查询验证：
- 并行查询执行
- 结果合并正确性
- 资源使用优化

### 5. 边界条件测试
异常情况处理：
- 空范围查询
- 不存在的前缀
- NULL参数检查
- 错误码验证

### 6. 超时机制测试
防死锁保护：
- 超时时间设定
- 查询中断机制
- 资源清理验证

### 7. 并发安全测试
多线程环境验证：
- 线程安全性
- 数据一致性
- 性能可扩展性

### 8. 统计功能测试
性能监控验证：
- 查询计数统计
- 平均时间计算
- 统计重置功能

## 超时保护机制

所有测试都配置了超时保护：
- **测试超时**: 10秒整体测试时间限制
- **查询超时**: 1-5秒单个查询时间限制
- **死锁检测**: 自动中断和清理
- **资源释放**: 确保测试失败时的资源清理

## 性能基准

### 预期性能指标
- **范围查询**: < 5ms (1000条记录)
- **前缀扫描**: < 3ms (匹配结果<100)
- **批量查询**: < 10ms (3个前缀)
- **并发查询**: 4线程×50操作，成功率>95%

### 内存使用
- **无内存泄漏**: Valgrind验证
- **合理内存占用**: 测试数据集<1MB
- **高效内存管理**: 自动释放机制

## 故障排除

### 常见问题

1. **编译错误**
   ```bash
   # 检查依赖文件是否存在
   ls ../../../kvserver/kv_range_query.*
   ls ../../../kvserver/btree_adapter.*
   ```

2. **测试超时**
   ```bash
   # 增加超时时间
   timeout 60 ./build/test_range_query
   ```

3. **内存泄漏**
   ```bash
   # 运行详细内存检查
   make valgrind
   ```

### 调试模式
```bash
# 编译调试版本
make CFLAGS="-g -O0 -DDEBUG"

# 使用GDB调试
gdb ./build/test_range_query
```

## 集成说明

### 与其他模块的关系
- **依赖**: kv_engine_interface.h, btree_adapter.c
- **集成**: 可与其他存储引擎配合测试
- **扩展**: 支持自定义测试场景

### 持续集成
```bash
# CI脚本示例
cd ConcordKV/tests/kvserver_tests/range_tests
make clean && make test
if [ $? -eq 0 ]; then
    echo "范围查询测试通过"
else
    echo "范围查询测试失败"
    exit 1
fi
```

## 开发说明

### 添加新测试
1. 在 `test_range_query.c` 中添加测试函数
2. 使用 `TEST_ASSERT` 宏进行断言
3. 添加超时保护机制
4. 更新本README文档

### 性能优化
- 使用 `gprof` 进行性能分析
- 监控内存使用模式
- 优化并发访问路径

## 作者和维护

- **作者**: Lzww0608
- **创建时间**: 2025-6-18
- **最后更新**: 2025-6-18
- **版本**: Phase 4.2

---
