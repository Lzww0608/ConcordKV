# æµ‹è¯•é¡¹ç›®çš„ Makefile
CC = gcc
CFLAGS = -Wall -g -O2 -fPIC -std=c99 -I../kvserver
LDFLAGS = -lpthread

# æºæ–‡ä»¶è·¯å¾„
KVSERVER_DIR = ../kvserver
ENGINE_TEST_DIR = engine_tests

# éœ€è¦é“¾æ¥çš„kvserverå¯¹è±¡æ–‡ä»¶
KVSERVER_OBJS = $(KVSERVER_DIR)/kv_memory.o $(KVSERVER_DIR)/kvstore_array.o $(KVSERVER_DIR)/kvstore_hash.o \
                $(KVSERVER_DIR)/kvstore_rbtree.o $(KVSERVER_DIR)/rbtree_adapter.o \
                $(KVSERVER_DIR)/kv_persist.o $(KVSERVER_DIR)/kv_concurrency.o \
                $(KVSERVER_DIR)/kv_transaction.o $(KVSERVER_DIR)/kv_error.o \
                $(KVSERVER_DIR)/kv_cluster.o $(KVSERVER_DIR)/kv_engine_factory.o

# æµ‹è¯•ç›®æ ‡
ENGINE_TEST = $(ENGINE_TEST_DIR)/kv_engine_test_enhanced
ORIGINAL_TEST = $(ENGINE_TEST_DIR)/kv_engine_test_original

# é»˜è®¤ç›®æ ‡
all: $(ENGINE_TEST) $(ORIGINAL_TEST)

# å¢å¼ºç‰ˆæµ‹è¯•ç¨‹åºï¼ˆåŒ…å«è¶…æ—¶æœºåˆ¶ï¼‰
$(ENGINE_TEST): $(ENGINE_TEST_DIR)/kv_engine_test_enhanced.o $(KVSERVER_OBJS)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# åŸç‰ˆæµ‹è¯•ç¨‹åºï¼ˆä»kvserverå¤åˆ¶ï¼‰
$(ENGINE_TEST_DIR)/kv_engine_test_original.c: $(KVSERVER_DIR)/kv_engine_test.c
	cp $< $@

$(ORIGINAL_TEST): $(ENGINE_TEST_DIR)/kv_engine_test_original.o $(KVSERVER_OBJS)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# ç¼–è¯‘è§„åˆ™
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# ç¡®ä¿kvserverå¯¹è±¡æ–‡ä»¶å­˜åœ¨
$(KVSERVER_OBJS):
	$(MAKE) -C $(KVSERVER_DIR) $(notdir $@)

# è¿è¡Œæµ‹è¯•
test: $(ENGINE_TEST)
	@echo "ğŸš€ è¿è¡Œå¢å¼ºç‰ˆå­˜å‚¨å¼•æ“æµ‹è¯•ï¼ˆåŒ…å«è¶…æ—¶æœºåˆ¶ï¼‰..."
	./$(ENGINE_TEST)

test_original: $(ORIGINAL_TEST)
	@echo "ğŸš€ è¿è¡ŒåŸç‰ˆå­˜å‚¨å¼•æ“æµ‹è¯•..."
	./$(ORIGINAL_TEST)

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test_all: test test_original
	@echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ"

# å†…å­˜æ£€æŸ¥
memcheck: $(ENGINE_TEST)
	@echo "ğŸ” è¿è¡Œå†…å­˜æ³„æ¼æ£€æŸ¥..."
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
	         --timeout=120 ./$(ENGINE_TEST)

# æ¸…ç†
clean:
	rm -f $(ENGINE_TEST) $(ORIGINAL_TEST)
	rm -f $(ENGINE_TEST_DIR)/*.o
	rm -f $(ENGINE_TEST_DIR)/kv_engine_test_original.c

# æ·±åº¦æ¸…ç†
clean_all: clean
	rm -f $(ENGINE_TEST_DIR)/*~ $(ENGINE_TEST_DIR)/*.bak $(ENGINE_TEST_DIR)/*.swp

# å®‰è£…ï¼ˆåˆ›å»ºç¬¦å·é“¾æ¥åˆ°ç³»ç»Ÿæµ‹è¯•ç›®å½•ï¼‰
install:
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ç¨‹åºåˆ° /usr/local/bin/concordkv-tests/"
	sudo mkdir -p /usr/local/bin/concordkv-tests/
	sudo cp $(ENGINE_TEST) /usr/local/bin/concordkv-tests/
	sudo chmod +x /usr/local/bin/concordkv-tests/$(notdir $(ENGINE_TEST))

# å¸è½½
uninstall:
	sudo rm -rf /usr/local/bin/concordkv-tests/

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark: $(ENGINE_TEST)
	@echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	./$(ENGINE_TEST) --benchmark

# å¹¶å‘å‹åŠ›æµ‹è¯•
stress: $(ENGINE_TEST)
	@echo "ğŸ’ª è¿è¡Œå¹¶å‘å‹åŠ›æµ‹è¯•..."
	./$(ENGINE_TEST) --stress

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ†˜ ConcordKV æµ‹è¯•ç³»ç»Ÿå¯ç”¨ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  test          - è¿è¡Œå¢å¼ºç‰ˆæµ‹è¯•ï¼ˆå¸¦è¶…æ—¶ï¼‰"
	@echo "  test_original - è¿è¡ŒåŸç‰ˆæµ‹è¯•"
	@echo "  test_all      - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  memcheck      - å†…å­˜æ³„æ¼æ£€æŸ¥"
	@echo "  benchmark     - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  stress        - å¹¶å‘å‹åŠ›æµ‹è¯•"
	@echo "  clean         - æ¸…ç†ç¼–è¯‘äº§ç‰©"
	@echo "  clean_all     - æ·±åº¦æ¸…ç†"
	@echo "  install       - å®‰è£…æµ‹è¯•ç¨‹åº"
	@echo "  uninstall     - å¸è½½æµ‹è¯•ç¨‹åº"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©"

# æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
info:
	@echo "ğŸ“‹ æµ‹è¯•ç³»ç»Ÿä¿¡æ¯:"
	@echo "CC: $(CC)"
	@echo "CFLAGS: $(CFLAGS)"
	@echo "LDFLAGS: $(LDFLAGS)"
	@echo "æµ‹è¯•ç¨‹åº: $(ENGINE_TEST) $(ORIGINAL_TEST)"
	@echo "ä¾èµ–å¯¹è±¡: $(KVSERVER_OBJS)"

.PHONY: all test test_original test_all memcheck clean clean_all install uninstall benchmark stress help info 