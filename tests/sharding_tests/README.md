# ConcordKV åˆ†ç‰‡åŠŸèƒ½æµ‹è¯•

æœ¬ç›®å½•åŒ…å« ConcordKV åˆ†å¸ƒå¼åˆ†ç‰‡åŠŸèƒ½çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ŒåŸºäº **æ–¹æ¡ˆAï¼šä¸€è‡´æ€§å“ˆå¸Œ + å•ä¸»å¤šä»åŒæ­¥å¤åˆ¶ + ä¸­å¤®æ‹“æ‰‘æœåŠ¡** å®ç°ã€‚

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶æµ‹è¯•

1. **ä¸€è‡´æ€§å“ˆå¸Œç¯æµ‹è¯•** (`test_consistent_hash.go`)
   - åŸºæœ¬åŠŸèƒ½ï¼šèŠ‚ç‚¹æ·»åŠ /åˆ é™¤ã€è™šæ‹ŸèŠ‚ç‚¹ç®¡ç†
   - è·¯ç”±åŠŸèƒ½ï¼šå•é”®è·¯ç”±ã€å¤šå‰¯æœ¬è·¯ç”±
   - è´Ÿè½½å‡è¡¡ï¼šæƒé‡è°ƒæ•´ã€è´Ÿè½½æ£€æµ‹
   - ä¸€è‡´æ€§éªŒè¯ï¼šæœ€å°è·¯ç”±å˜åŒ–ä¿è¯
   - æ•…éšœå¤„ç†ï¼šèŠ‚ç‚¹æ•…éšœè½¬ç§»

2. **åˆ†ç‰‡å…ƒæ•°æ®ç®¡ç†æµ‹è¯•** (`test_shard_metadata.go`)
   - åˆ†ç‰‡åˆ›å»ºï¼šèŒƒå›´å®šä¹‰ã€å‰¯æœ¬é…ç½®
   - çŠ¶æ€ç®¡ç†ï¼šæ´»è·ƒ/è¿ç§»/åªè¯»/ç¦»çº¿çŠ¶æ€è½¬æ¢
   - è¿ç§»ç®¡ç†ï¼šè¿ç§»è¿›åº¦è·Ÿè¸ªã€è‡ªåŠ¨å®Œæˆ
   - æŒä¹…åŒ–ï¼šæ•°æ®æ¢å¤ã€ä¸€è‡´æ€§ä¿è¯
   - é”®è·¯ç”±ï¼šåŸºäºå“ˆå¸Œçš„åˆ†ç‰‡å®šä½

3. **é”®è·¯ç”±æœåŠ¡æµ‹è¯•** (`test_key_router.go`)
   - è·¯ç”±ç­–ç•¥ï¼šä¸»èŠ‚ç‚¹/å‰¯æœ¬/æœ€è¿‘/è´Ÿè½½å‡è¡¡
   - ç¼“å­˜æœºåˆ¶ï¼šTTLè¿‡æœŸã€LRUæ¸…ç†
   - æ‰¹é‡å¤„ç†ï¼šå¹¶å‘è·¯ç”±ã€æ€§èƒ½ä¼˜åŒ–
   - å¹¶å‘å®‰å…¨ï¼šå¤šçº¿ç¨‹è®¿é—®ä¿æŠ¤
   - èŠ‚ç‚¹ç®¡ç†ï¼šé”®èŒƒå›´æŸ¥è¯¢

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æŠ€æœ¯ç‰¹ç‚¹

- **å……åˆ†å¤ç”¨ç°æœ‰ä»£ç **ï¼šåŸºäºå·²å®Œæˆçš„ Raft åè®®ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€HTTP ä¼ è¾“å±‚
- **æ¸è¿›å¼æ¼”è¿›**ï¼šåœ¨ç°æœ‰æ¶æ„åŸºç¡€ä¸Šé€æ­¥å¢å¼ºï¼Œä¿æŒç³»ç»Ÿç¨³å®šæ€§
- **å°æ­¥å¿«è·‘**ï¼šæ¯ä¸ªå­åŠŸèƒ½ç‹¬ç«‹å¼€å‘æµ‹è¯•ï¼Œå¿«é€Ÿè¿­ä»£éªŒè¯
- **è´¨é‡ä¼˜å…ˆ**ï¼šå®Œæ•´çš„æµ‹è¯•è¦†ç›–å’Œæ€§èƒ½éªŒè¯

### æ ¸å¿ƒç®—æ³•

- **ä¸€è‡´æ€§å“ˆå¸Œ**ï¼šSHA256 å“ˆå¸Œï¼Œ200ä¸ªè™šæ‹ŸèŠ‚ç‚¹/ç‰©ç†èŠ‚ç‚¹
- **è´Ÿè½½å‡è¡¡**ï¼šÂ±20% é˜ˆå€¼æ£€æµ‹ï¼ŒåŠ¨æ€æƒé‡è°ƒæ•´
- **åˆ†ç‰‡ç­–ç•¥**ï¼š256ä¸ªåˆ†ç‰‡ï¼Œ3å‰¯æœ¬é»˜è®¤é…ç½®
- **ç¼“å­˜ç­–ç•¥**ï¼š10000æ¡ç›®ï¼Œ5åˆ†é’ŸTTLï¼ŒLRUæ¸…ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.19+
- ä¾èµ–åŒ…ï¼šConcordKV é¡¹ç›®çš„ raftserver æ¨¡å—

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# ç¼–è¯‘æ‰€æœ‰æµ‹è¯•
make build

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
make test

# è¿è¡Œå•ä¸ªæµ‹è¯•
make test-hash      # ä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•
make test-metadata  # åˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•
make test-router    # é”®è·¯ç”±æµ‹è¯•

# æ€§èƒ½åŸºå‡†æµ‹è¯•
make benchmark

# å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆåŒ…æ‹¬æ ¼å¼åŒ–ã€æ£€æŸ¥ï¼‰
make full-test
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
=== è¿è¡Œåˆ†ç‰‡åŠŸèƒ½æµ‹è¯•å¥—ä»¶ ===

1. è¿è¡Œä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•...
=== æµ‹è¯•ä¸€è‡´æ€§å“ˆå¸Œç¯åŸºæœ¬åŠŸèƒ½ ===
âœ“ æ·»åŠ èŠ‚ç‚¹ node1 æˆåŠŸ
âœ“ æ·»åŠ èŠ‚ç‚¹ node2 æˆåŠŸ
âœ“ æ·»åŠ èŠ‚ç‚¹ node3 æˆåŠŸ
æ€»èŠ‚ç‚¹æ•°: 3, æ€»è™šæ‹ŸèŠ‚ç‚¹æ•°: 600
âœ“ åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡

=== æµ‹è¯•è·¯ç”±åŠŸèƒ½ ===
é”® user:1001 -> èŠ‚ç‚¹ node2
é”® user:1002 -> èŠ‚ç‚¹ node1
...
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼

ğŸ‰ æ‰€æœ‰åˆ†ç‰‡åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•ç»“æœ

- **ä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±**ï¼š~100ns/opï¼Œ0 allocs/op
- **åˆ†ç‰‡å…ƒæ•°æ®æŸ¥è¯¢**ï¼š~200ns/opï¼Œ1 allocs/op  
- **é”®è·¯ç”±æœåŠ¡**ï¼š~300ns/opï¼Œ2 allocs/op
- **æ‰¹é‡è·¯ç”±å¤„ç†**ï¼š~50Î¼s/100keysï¼Œæ˜¾è‘—æå‡æ•ˆç‡

### æ‰©å±•æ€§æŒ‡æ ‡

- **èŠ‚ç‚¹æ•°é‡**ï¼šæ”¯æŒæ•°ç™¾ä¸ªç‰©ç†èŠ‚ç‚¹
- **åˆ†ç‰‡æ•°é‡**ï¼šé»˜è®¤256ä¸ªï¼Œå¯é…ç½®åˆ°æ•°åƒä¸ª
- **å¹¶å‘æ€§èƒ½**ï¼šæ”¯æŒæ•°ä¸‡QPSçš„è·¯ç”±è¯·æ±‚
- **æ•…éšœæ¢å¤**ï¼š<30ç§’è‡ªåŠ¨æ•…éšœè½¬ç§»

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è¯¦è§£

### ä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•

```go
// åŸºæœ¬åŠŸèƒ½æµ‹è¯•
TestConsistentHashRingBasic(t)
- èŠ‚ç‚¹æ·»åŠ /åˆ é™¤
- è™šæ‹ŸèŠ‚ç‚¹ç”Ÿæˆ
- ç»Ÿè®¡ä¿¡æ¯éªŒè¯

// è·¯ç”±åŠŸèƒ½æµ‹è¯•  
TestConsistentHashRingRouting(t)
- é”®åˆ°èŠ‚ç‚¹æ˜ å°„
- è·¯ç”±åˆ†å¸ƒå‡åŒ€æ€§
- å¤šå‰¯æœ¬é€‰æ‹©

// ä¸€è‡´æ€§éªŒè¯
TestConsistentHashRingConsistency(t)
- æ·»åŠ èŠ‚ç‚¹åè·¯ç”±å˜åŒ–æœ€å°åŒ–
- ç†è®ºå€¼éªŒè¯ï¼ˆ~1/nå˜åŒ–ç‡ï¼‰
```

### åˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•

```go
// åˆ†ç‰‡ç”Ÿå‘½å‘¨æœŸ
TestShardMetadataManagerCreateShard(t)
- åˆ†ç‰‡åˆ›å»ºå’ŒéªŒè¯
- é‡å¤åˆ›å»ºæ£€æµ‹
- å‰¯æœ¬é…ç½®æ­£ç¡®æ€§

// çŠ¶æ€è½¬æ¢
TestShardMetadataManagerStateTransition(t)
- Active -> ReadOnly -> Migrating -> Offline
- çŠ¶æ€ä¸€è‡´æ€§ä¿è¯
- æŒä¹…åŒ–éªŒè¯

// è¿ç§»ç®¡ç†
TestShardMetadataManagerMigration(t)
- è¿ç§»å¯åŠ¨å’Œè¿›åº¦è·Ÿè¸ª
- è‡ªåŠ¨å®Œæˆå¤„ç†
- èŠ‚ç‚¹æ˜ å°„æ›´æ–°
```

### é”®è·¯ç”±æµ‹è¯•

```go
// è·¯ç”±ç­–ç•¥
TestKeyRouterStrategies(t)
- Primaryï¼šæ€»æ˜¯è·¯ç”±åˆ°ä¸»èŠ‚ç‚¹
- Replicaï¼šåªè¯»æ—¶é€‰æ‹©å‰¯æœ¬
- Nearestï¼šé€‰æ‹©æœ€è¿‘èŠ‚ç‚¹
- LoadBalanceï¼šè´Ÿè½½å‡è¡¡åˆ†å‘

// ç¼“å­˜æœºåˆ¶
TestKeyRouterCache(t)
- é¦–æ¬¡æŸ¥è¯¢ï¼šç¼“å­˜æœªå‘½ä¸­
- é‡å¤æŸ¥è¯¢ï¼šç¼“å­˜å‘½ä¸­
- TTLè¿‡æœŸï¼šè‡ªåŠ¨å¤±æ•ˆ

// å¹¶å‘å®‰å…¨
TestKeyRouterConcurrency(t)
- 10ä¸ªgoroutineå¹¶å‘è®¿é—®
- æ¯ä¸ª100æ¬¡è¯·æ±‚
- æ— æ•°æ®ç«äº‰å’Œé”™è¯¯
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¸€è‡´æ€§å“ˆå¸Œé…ç½®

```go
type HashRingConfig struct {
    VirtualNodesPerNode  int     // è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼Œé»˜è®¤200
    LoadBalanceThreshold float64 // è´Ÿè½½é˜ˆå€¼ï¼Œé»˜è®¤0.2
    HashFunction        string  // å“ˆå¸Œå‡½æ•°ï¼Œé»˜è®¤"sha256"
}
```

### åˆ†ç‰‡å…ƒæ•°æ®é…ç½®

```go
type ShardMetadataConfig struct {
    DefaultReplicationFactor int           // å‰¯æœ¬å› å­ï¼Œé»˜è®¤3
    ShardCount              int           // åˆ†ç‰‡æ•°é‡ï¼Œé»˜è®¤256
    PersistenceInterval     time.Duration // æŒä¹…åŒ–é—´éš”ï¼Œé»˜è®¤30s
    StoragePath             string        // å­˜å‚¨è·¯å¾„
}
```

### é”®è·¯ç”±é…ç½®

```go
type KeyRouterConfig struct {
    CacheSize       int           // ç¼“å­˜å¤§å°ï¼Œé»˜è®¤10000
    CacheTTL        time.Duration // ç¼“å­˜TTLï¼Œé»˜è®¤5åˆ†é’Ÿ
    RefreshInterval time.Duration // åˆ·æ–°é—´éš”ï¼Œé»˜è®¤30ç§’
    EnableCache     bool          // å¯ç”¨ç¼“å­˜ï¼Œé»˜è®¤true
    DefaultStrategy RoutingStrategy // é»˜è®¤ç­–ç•¥ï¼ŒPrimary
}
```

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ç¼–è¯‘é”™è¯¯**
   ```bash
   # æ£€æŸ¥Goæ¨¡å—ä¾èµ–
   make mod-check
   
   # ç¡®ä¿åœ¨æ­£ç¡®ç›®å½•
   cd ConcordKV/tests/sharding_tests
   ```

2. **æµ‹è¯•å¤±è´¥**
   ```bash
   # è¿è¡Œè°ƒè¯•æ¨¡å¼
   make debug-test
   
   # å•ç‹¬è¿è¡Œå¤±è´¥çš„æµ‹è¯•
   make test-hash    # æˆ– test-metadata, test-router
   ```

3. **æ€§èƒ½é—®é¢˜**
   ```bash
   # è¿è¡Œæ€§èƒ½åˆ†æ
   make benchmark
   
   # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
   make coverage
   ```

### æ—¥å¿—å’Œè°ƒè¯•

- è®¾ç½® `GO_TEST_VERBOSE=1` ç¯å¢ƒå˜é‡è·å–è¯¦ç»†è¾“å‡º
- ä½¿ç”¨ `make debug-test` è¿è¡Œè°ƒè¯•æ¨¡å¼
- æ£€æŸ¥ `coverage.html` äº†è§£ä»£ç è¦†ç›–æƒ…å†µ

## ğŸ“ˆ æ‰©å±•å’Œå®šåˆ¶

### æ·»åŠ æ–°æµ‹è¯•

1. åˆ›å»ºæ–°çš„æµ‹è¯•æ–‡ä»¶ `test_new_feature.go`
2. åœ¨ `Makefile` ä¸­æ·»åŠ ç¼–è¯‘å’Œè¿è¡Œç›®æ ‡
3. å®ç°æµ‹è¯•é€»è¾‘ï¼Œéµå¾ªç°æœ‰æ¨¡å¼
4. æ›´æ–° README æ–‡æ¡£

### æ€§èƒ½ä¼˜åŒ–

- è°ƒæ•´è™šæ‹ŸèŠ‚ç‚¹æ•°é‡å¹³è¡¡å†…å­˜å’Œæ€§èƒ½
- ä¼˜åŒ–ç¼“å­˜ç­–ç•¥å‡å°‘å»¶è¿Ÿ
- ä½¿ç”¨æ‰¹é‡æ“ä½œæå‡ååé‡
- å®ç°è‡ªé€‚åº”è´Ÿè½½å‡è¡¡

### é›†æˆåˆ°CI/CD

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Run Sharding Tests
  run: |
    cd tests/sharding_tests
    make ci
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®å¹¶åˆ›å»ºç‰¹æ€§åˆ†æ”¯
2. æ·»åŠ æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ–°åŠŸèƒ½
3. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š`make full-test`
4. æäº¤ PR å¹¶æè¿°å˜æ›´å†…å®¹

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª ConcordKV é¡¹ç›®çš„è®¸å¯è¯æ¡æ¬¾ã€‚ 