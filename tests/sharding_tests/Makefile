# ConcordKV Sharding Tests Makefile
# Author: Lzww0608
# Date: 2025-6-21 21:31:41
# Goç›¸å…³è®¾ç½®
GO := go
GOFLAGS := -v
GOBUILD := $(GO) build $(GOFLAGS)
GOTEST := $(GO) test $(GOFLAGS)
GORUN := $(GO) run $(GOFLAGS)

# é¡¹ç›®è·¯å¾„
PROJECT_ROOT := ../..
SHARDING_PKG := $(PROJECT_ROOT)/raftserver/sharding

# æµ‹è¯•æ–‡ä»¶
TEST_FILES := test_consistent_hash.go test_shard_metadata_only.go test_key_router_simple.go

# ç¼–è¯‘è¾“å‡ºç›®å½•
BUILD_DIR := build
BINARIES := $(BUILD_DIR)/test_consistent_hash $(BUILD_DIR)/test_shard_metadata_only $(BUILD_DIR)/test_key_router_simple

# é»˜è®¤ç›®æ ‡
.PHONY: all
all: build

# åˆ›å»ºæ„å»ºç›®å½•
$(BUILD_DIR):
	@echo "åˆ›å»ºæ„å»ºç›®å½•..."
	@mkdir -p $(BUILD_DIR)

# ç¼–è¯‘æ‰€æœ‰æµ‹è¯•
.PHONY: build
build: $(BUILD_DIR) $(BINARIES)
	@echo "æ‰€æœ‰æµ‹è¯•ç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘ä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•
$(BUILD_DIR)/test_consistent_hash: test_consistent_hash.go
	@echo "ç¼–è¯‘ä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•..."
	@$(GOBUILD) -o $(BUILD_DIR)/test_consistent_hash test_consistent_hash.go

# ç¼–è¯‘åˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•
$(BUILD_DIR)/test_shard_metadata_only: test_shard_metadata_only.go
	@echo "ç¼–è¯‘åˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•..."
	@$(GOBUILD) -o $(BUILD_DIR)/test_shard_metadata_only test_shard_metadata_only.go

# ç¼–è¯‘é”®è·¯ç”±æµ‹è¯•
$(BUILD_DIR)/test_key_router_simple: test_key_router_simple.go
	@echo "ç¼–è¯‘é”®è·¯ç”±æµ‹è¯•..."
	@$(GOBUILD) -o $(BUILD_DIR)/test_key_router_simple test_key_router_simple.go

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
.PHONY: test
test: build
	@echo "=== è¿è¡Œåˆ†ç‰‡åŠŸèƒ½æµ‹è¯•å¥—ä»¶ ==="
	@echo ""
	@echo "1. è¿è¡Œä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•..."
	@./$(BUILD_DIR)/test_consistent_hash || (echo "âŒ ä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•å¤±è´¥" && exit 1)
	@echo ""
	@echo "2. è¿è¡Œåˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•..."
	@./$(BUILD_DIR)/test_shard_metadata_only || (echo "âŒ åˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•å¤±è´¥" && exit 1)
	@echo ""
	@echo "3. è¿è¡Œé”®è·¯ç”±æµ‹è¯•..."
	@./$(BUILD_DIR)/test_key_router_simple || (echo "âŒ é”®è·¯ç”±æµ‹è¯•å¤±è´¥" && exit 1)
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰åˆ†ç‰‡åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼"

# å•ç‹¬è¿è¡Œä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•
.PHONY: test-hash
test-hash: $(BUILD_DIR)/test_consistent_hash
	@echo "è¿è¡Œä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•..."
	@./$(BUILD_DIR)/test_consistent_hash

# å•ç‹¬è¿è¡Œåˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•
.PHONY: test-metadata
test-metadata: $(BUILD_DIR)/test_shard_metadata_only
	@echo "è¿è¡Œåˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•..."
	@./$(BUILD_DIR)/test_shard_metadata_only

# å•ç‹¬è¿è¡Œé”®è·¯ç”±æµ‹è¯•
.PHONY: test-router
test-router: $(BUILD_DIR)/test_key_router_simple
	@echo "è¿è¡Œé”®è·¯ç”±æµ‹è¯•..."
	@./$(BUILD_DIR)/test_key_router_simple

# è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
.PHONY: benchmark
benchmark: build
	@echo "=== è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯• ==="
	@echo ""
	@echo "1. ä¸€è‡´æ€§å“ˆå¸Œæ€§èƒ½æµ‹è¯•..."
	@cd $(PROJECT_ROOT) && $(GO) test -bench=BenchmarkConsistentHashRingRouting -benchmem tests/sharding_tests/test_consistent_hash.go
	@echo ""
	@echo "2. åˆ†ç‰‡å…ƒæ•°æ®æ€§èƒ½æµ‹è¯•..."
	@cd $(PROJECT_ROOT) && $(GO) test -bench=BenchmarkShardMetadataManagerRouting -benchmem tests/sharding_tests/test_shard_metadata_only.go
	@echo ""
	@echo "3. é”®è·¯ç”±æ€§èƒ½æµ‹è¯•..."
	@cd $(PROJECT_ROOT) && $(GO) test -bench=BenchmarkKeyRouter -benchmem tests/sharding_tests/test_key_router_simple.go

# è¿è¡Œä»£ç è¦†ç›–ç‡æµ‹è¯•
.PHONY: coverage
coverage:
	@echo "=== ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š ==="
	@cd $(PROJECT_ROOT) && $(GO) test -coverprofile=coverage.out -covermode=atomic ./raftserver/sharding/...
	@cd $(PROJECT_ROOT) && $(GO) tool cover -html=coverage.out -o coverage.html
	@echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html"

# ä»£ç æ ¼å¼åŒ–
.PHONY: fmt
fmt:
	@echo "æ ¼å¼åŒ–æµ‹è¯•ä»£ç ..."
	@$(GO) fmt $(TEST_FILES)
	@cd $(PROJECT_ROOT) && $(GO) fmt ./raftserver/sharding/...

# ä»£ç æ£€æŸ¥
.PHONY: vet
vet:
	@echo "æ£€æŸ¥æµ‹è¯•ä»£ç ..."
	@cd $(PROJECT_ROOT) && $(GO) vet ./tests/sharding_tests/...
	@cd $(PROJECT_ROOT) && $(GO) vet ./raftserver/sharding/...

# ä¾èµ–æ£€æŸ¥
.PHONY: mod-check
mod-check:
	@echo "æ£€æŸ¥Goæ¨¡å—ä¾èµ–..."
	@cd $(PROJECT_ROOT) && $(GO) mod tidy
	@cd $(PROJECT_ROOT) && $(GO) mod verify

# æ¸…ç†æ„å»ºæ–‡ä»¶
.PHONY: clean
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR)
	@rm -f $(PROJECT_ROOT)/coverage.out $(PROJECT_ROOT)/coverage.html

# å®Œæ•´çš„æµ‹è¯•æµç¨‹ï¼ˆåŒ…æ‹¬æ ¼å¼åŒ–ã€æ£€æŸ¥ã€æµ‹è¯•ï¼‰
.PHONY: full-test
full-test: fmt vet mod-check test
	@echo "å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ"

# æŒç»­é›†æˆæµ‹è¯•
.PHONY: ci
ci: clean full-test benchmark coverage
	@echo "æŒç»­é›†æˆæµ‹è¯•å®Œæˆ"

# å¿«é€Ÿæµ‹è¯•ï¼ˆä»…ç¼–è¯‘å’Œè¿è¡Œï¼‰
.PHONY: quick-test
quick-test: build test

# è°ƒè¯•æ¨¡å¼è¿è¡Œæµ‹è¯•
.PHONY: debug-test
debug-test: build
	@echo "=== è°ƒè¯•æ¨¡å¼è¿è¡Œæµ‹è¯• ==="
	@echo "è®¾ç½®è¯¦ç»†è¾“å‡º..."
	@export GO_TEST_VERBOSE=1
	@./$(BUILD_DIR)/test_consistent_hash
	@./$(BUILD_DIR)/test_shard_metadata_only  
	@./$(BUILD_DIR)/test_key_router_simple

# å‹åŠ›æµ‹è¯•
.PHONY: stress-test
stress-test: build
	@echo "=== è¿è¡Œå‹åŠ›æµ‹è¯• ==="
	@echo "è¿è¡Œé•¿æ—¶é—´æµ‹è¯•..."
	@for i in $$(seq 1 10); do \
		echo "ç¬¬ $$i è½®æµ‹è¯•..."; \
		./$(BUILD_DIR)/test_consistent_hash > /dev/null || exit 1; \
		./$(BUILD_DIR)/test_shard_metadata_only > /dev/null || exit 1; \
		./$(BUILD_DIR)/test_key_router_simple > /dev/null || exit 1; \
	done
	@echo "å‹åŠ›æµ‹è¯•å®Œæˆ"

# å†…å­˜æ³„æ¼æ£€æµ‹
.PHONY: memcheck
memcheck: build
	@echo "=== å†…å­˜æ³„æ¼æ£€æµ‹ ==="
	@echo "æ³¨æ„ï¼šéœ€è¦å®‰è£…valgrind"
	@valgrind --leak-check=full --show-leak-kinds=all ./$(BUILD_DIR)/test_consistent_hash
	@valgrind --leak-check=full --show-leak-kinds=all ./$(BUILD_DIR)/test_shard_metadata_only
	@valgrind --leak-check=full --show-leak-kinds=all ./$(BUILD_DIR)/test_key_router_simple

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
.PHONY: help
help:
	@echo "ConcordKV åˆ†ç‰‡åŠŸèƒ½æµ‹è¯• Makefile"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡ï¼š"
	@echo "  build         - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•"
	@echo "  test          - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-hash     - è¿è¡Œä¸€è‡´æ€§å“ˆå¸Œæµ‹è¯•"
	@echo "  test-metadata - è¿è¡Œåˆ†ç‰‡å…ƒæ•°æ®æµ‹è¯•"
	@echo "  test-router   - è¿è¡Œé”®è·¯ç”±æµ‹è¯•"
	@echo "  benchmark     - è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  coverage      - ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  fmt           - æ ¼å¼åŒ–ä»£ç "
	@echo "  vet           - ä»£ç é™æ€æ£€æŸ¥"
	@echo "  mod-check     - æ£€æŸ¥Goæ¨¡å—ä¾èµ–"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  full-test     - å®Œæ•´æµ‹è¯•æµç¨‹"
	@echo "  ci            - æŒç»­é›†æˆæµ‹è¯•"
	@echo "  quick-test    - å¿«é€Ÿæµ‹è¯•"
	@echo "  debug-test    - è°ƒè¯•æ¨¡å¼æµ‹è¯•"
	@echo "  stress-test   - å‹åŠ›æµ‹è¯•"
	@echo "  memcheck      - å†…å­˜æ³„æ¼æ£€æµ‹"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹ï¼š"
	@echo "  make test           # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-hash      # åªè¿è¡Œå“ˆå¸Œæµ‹è¯•"
	@echo "  make benchmark      # è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  make full-test      # å®Œæ•´æµ‹è¯•æµç¨‹" 