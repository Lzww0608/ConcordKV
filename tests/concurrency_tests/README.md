# ConcordKV 并发控制增强功能测试

本目录包含了ConcordKV项目中并发控制优化的测试代码，主要实现了ROADMAP中提到的死锁检测和锁超时处理功能。

## 功能特性

### 🔒 死锁检测
- **实时死锁检测**: 监控线程间的锁依赖关系
- **超时机制**: 防止无限等待，自动检测潜在死锁
- **锁图管理**: 维护线程-锁依赖图，快速识别循环等待

### ⏱️ 锁超时处理
- **可配置超时**: 支持毫秒级超时设置
- **优雅降级**: 超时后自动释放已获取的锁
- **错误码返回**: 明确区分超时、死锁和其他错误

### 🎯 细粒度锁控制
- **分段锁**: 减少锁竞争，提高并发性能
- **读写锁**: 支持多读者-单写者模式
- **多键原子操作**: 按键排序避免死锁
- **自旋锁**: 适用于短时间临界区

## 文件结构

```
concurrency_tests/
├── README.md                    # 本文件
├── Makefile                     # 编译配置
├── run_tests.sh                 # 自动化测试脚本
├── test_deadlock_detection.c    # 死锁检测功能测试
└── test_lock_stress.c           # 并发压力测试
```

## 快速开始

### 1. 编译测试程序

```bash
# 编译所有测试
make all

# 或者编译特定测试
make test_deadlock_detection
make test_lock_stress
```

### 2. 运行测试

#### 自动化测试（推荐）
```bash
# 运行完整测试套件
./run_tests.sh

# 运行特定测试
./run_tests.sh basic      # 基础功能测试
./run_tests.sh stress     # 压力测试
./run_tests.sh benchmark  # 性能基准测试
./run_tests.sh memory     # 内存检查
```

#### 手动运行测试
```bash
# 死锁检测测试
./test_deadlock_detection

# 压力测试（可配置参数）
./test_lock_stress [线程数] [键数] [读操作百分比]

# 示例：8线程，100键，70%读操作
./test_lock_stress 8 100 70
```

### 3. 查看结果

测试完成后会生成详细的统计报告，包括：
- 操作成功率
- 超时检测率
- 死锁检测率
- 平均锁定时间
- 系统吞吐量

## 测试说明

### 死锁检测测试 (`test_deadlock_detection.c`)

测试内容：
- ✅ 基本锁超时功能
- ✅ 分段锁并发性能
- ✅ 死锁场景模拟
- ✅ 锁排序避免死锁
- ✅ 多键原子操作

关键测试场景：
1. **超时测试**: 验证锁在指定时间内超时
2. **并发测试**: 多线程随机访问共享资源
3. **死锁模拟**: 故意制造死锁场景验证检测能力
4. **排序锁定**: 验证多键锁定的死锁避免机制

### 压力测试 (`test_lock_stress.c`)

测试内容：
- 🚀 高并发场景下的锁性能
- 📊 不同线程数量的可扩展性
- 🔄 读写操作比例的影响
- 📈 系统吞吐量和延迟统计

测试配置：
- **线程数**: 1-32个并发线程
- **键空间**: 10-1000个不同的键
- **读写比例**: 0-100%的读操作比例
- **测试时长**: 可配置的测试持续时间

## 性能指标

### 关键指标
- **吞吐量**: 每秒完成的锁操作数
- **成功率**: 成功获取锁的操作百分比
- **平均延迟**: 获取锁的平均时间（微秒）
- **超时率**: 因超时失败的操作百分比
- **死锁检测率**: 检测到死锁的操作百分比

### 性能优化特性
1. **分段锁**: 将锁空间分割，减少竞争
2. **锁排序**: 多键操作按键排序，避免死锁
3. **读写分离**: 读操作可并发，写操作独占
4. **超时机制**: 避免无限等待，提高系统响应性

## 配置选项

### 编译选项
```bash
# 调试版本（包含详细日志）
make debug

# 发布版本（性能优化）
make release

# 内存检查版本
make memcheck
```

### 运行时配置
- `TEST_TIMEOUT_MS`: 锁超时时间（毫秒）
- `NUM_THREADS`: 并发线程数量
- `NUM_KEYS`: 测试键的数量
- `TEST_DURATION_SEC`: 测试持续时间（秒）

## 故障排除

### 常见问题

1. **编译错误**
   ```bash
   # 检查依赖
   make check-deps
   
   # 清理重新编译
   make clean && make all
   ```

2. **测试超时**
   - 减少线程数量或键数量
   - 增加超时时间设置
   - 检查系统负载

3. **内存泄漏**
   ```bash
   # 运行内存检查
   make memcheck
   
   # 或使用valgrind
   valgrind --tool=memcheck ./test_deadlock_detection
   ```

4. **死锁检测失效**
   - 确保死锁检测器已初始化
   - 检查超时时间设置是否合理
   - 验证锁的获取和释放是否配对

### 调试技巧

1. **启用调试模式**
   ```bash
   make debug
   ```

2. **查看详细日志**
   ```bash
   ./test_deadlock_detection 2>&1 | tee debug.log
   ```

3. **使用GDB调试**
   ```bash
   gdb ./test_deadlock_detection
   (gdb) run
   ```

## 扩展开发

### 添加新测试

1. 创建新的测试文件
2. 在Makefile中添加编译规则
3. 在run_tests.sh中添加测试调用
4. 更新README文档

### 性能调优

1. **调整分段锁数量**: 根据键空间大小优化
2. **优化哈希函数**: 改善键分布均匀性
3. **调整超时时间**: 平衡响应性和成功率
4. **优化内存分配**: 减少动态内存分配

## 贡献指南

1. 遵循现有代码风格
2. 添加充分的测试覆盖
3. 更新相关文档
4. 确保所有测试通过

## 许可证

本项目遵循ConcordKV项目的许可证。

---

**注意**: 这些测试专门针对ROADMAP中的并发控制优化需求设计，重点关注死锁检测和锁超时处理的正确性和性能。在生产环境中使用前，请根据实际负载特征进行充分测试。 