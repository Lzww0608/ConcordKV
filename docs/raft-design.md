# ConcordKV Raft设计文档

## 1. 概述

ConcordKV使用Raft共识算法来确保集群中的节点对操作顺序达成一致，并在节点故障的情况下保持系统的可用性。本文档描述了ConcordKV中Raft协议的设计和实现细节。

## 2. Raft协议基础

Raft是一种用于分布式系统的共识算法，通过复制日志的方式来保证系统的一致性。Raft协议的核心特性包括：

- **领导者选举**：选择一个节点作为领导者，负责处理所有客户端请求
- **日志复制**：领导者将操作记录在日志中，并复制到其他节点
- **安全性**：确保所有节点按照相同的顺序应用相同的操作

## 3. ConcordKV中的Raft实现

### 3.1 节点状态

每个Raft节点可以处于以下三种状态之一：

- **Follower（跟随者）**：被动接收领导者的请求，响应领导者和候选人的消息
- **Candidate（候选人）**：在选举过程中寻求成为领导者的节点
- **Leader（领导者）**：处理所有客户端请求，并将更改复制到其他节点

### 3.2 持久化状态

每个节点需要持久化以下状态：

- **currentTerm**：节点所见过的最高任期
- **votedFor**：当前任期中投票给的候选人ID
- **log[]**：操作日志条目，每个条目包含命令和接收时的任期

### 3.3 易失性状态

#### 所有节点：
- **commitIndex**：已知已提交的最高日志条目索引
- **lastApplied**：已应用到状态机的最高日志条目索引

#### 仅领导者：
- **nextIndex[]**：要发送给每个节点的下一个日志条目索引
- **matchIndex[]**：每个节点已复制的最高日志条目索引

## 4. 关键算法和流程

### 4.1 领导者选举

1. 当Follower超过选举超时时间未收到Leader的心跳，转变为Candidate
2. Candidate增加当前任期，投票给自己，并向其他节点发送RequestVote RPC
3. 如果获得多数票，成为Leader；如果收到新Leader的AppendEntries RPC，变回Follower；如果选举超时，开始新一轮选举

### 4.2 日志复制

1. Leader接收客户端请求，将操作添加到本地日志
2. Leader向所有Follower发送AppendEntries RPC，包含新的日志条目
3. 当多数节点确认复制后，Leader提交该日志条目
4. Leader通知所有Follower日志已提交，Follower将日志应用到其状态机

### 4.3 安全性保障

- **选举限制**：候选人必须包含所有已提交的日志条目才能当选为领导者
- **日志匹配**：如果两个日志条目有相同的索引和任期，则它们包含相同的命令
- **Leader Completeness**：如果日志条目在某个任期被提交，则此条目将出现在所有更高任期的Leader日志中

## 5. ConcordKV特定扩展

### 5.1 成员变更

ConcordKV实现了单节点变更算法，允许在不中断服务的情况下添加或删除节点：

1. 领导者收到配置变更请求，创建包含当前和新配置的过渡配置日志条目(C_old,new)
2. 复制并提交过渡配置日志条目
3. 创建仅包含新配置的日志条目(C_new)，复制并提交
4. 集群完成配置变更

### 5.2 快照和日志压缩

为防止日志无限增长，ConcordKV实现了快照机制：

1. 每个节点独立创建状态机的快照并丢弃该点之前的日志
2. Leader向落后太多的Follower发送快照
3. Follower收到快照后，替换其本地状态

### 5.3 读请求优化

为提高读操作性能，ConcordKV实现了以下优化：

1. **ReadIndex**：Leader先确认自己仍是当前Leader，然后返回本地状态机数据
2. **Lease Read**：使用租约机制，在租约期间Leader直接返回本地数据，无需确认领导地位

## 6. 与存储引擎的集成

Raft模块通过以下接口与C/C++存储引擎集成：

1. **命令应用**：Raft将已提交的命令传递给存储引擎执行
2. **快照管理**：存储引擎提供创建和恢复快照的接口
3. **状态查询**：Raft可以查询存储引擎的状态用于只读请求

## 7. 性能优化

- **流水线复制**：允许Leader并行发送多个AppendEntries RPC，而不必等待前一个完成
- **批量复制**：合并多个客户端请求在单个AppendEntries RPC中发送
- **预投票**：减少不必要的任期增加，避免集群中断
- **异步应用**：提交的日志条目可以异步应用到状态机

## 8. 监控和指标

ConcordKV的Raft实现提供以下关键指标用于监控：

- 领导者选举频率
- 日志复制延迟
- 提交延迟
- 应用延迟
- 节点间通信状态
- 各状态节点数量

## 9. 容错和恢复

- **自动重新加入**：崩溃后重启的节点能自动重新加入集群
- **数据恢复**：通过持久化状态和快照实现数据恢复
- **网络分区处理**：少数分区节点会成为只读状态，保证系统安全性

## 10. 未来工作

- **分层Raft**：支持更大规模的集群
- **预写优化**：减少写入延迟
- **Learner角色**：支持无投票权的观察者节点
- **跨数据中心复制**：优化广域网环境下的复制性能