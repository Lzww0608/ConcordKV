# ConcordKV Arenaå†…å­˜æ± å®ç°æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ConcordKVé¡¹ç›®ä¸­åŸºäºLevelDBè®¾è®¡ç†å¿µçš„Arenaå†…å­˜æ± å®ç°ã€‚Arenaå†…å­˜æ± æ˜¯ä¸€ç§é«˜æ€§èƒ½å†…å­˜åˆ†é…ç­–ç•¥ï¼Œç‰¹åˆ«é€‚åˆæ‰¹é‡åˆ†é…å’Œç”Ÿå‘½å‘¨æœŸç›¸åŒçš„å†…å­˜ä½¿ç”¨åœºæ™¯ã€‚

**ä½œè€…**: Lzww0608  
**æ—¥æœŸ**: 2025-06-13 
**ç‰ˆæœ¬**: 1.0  

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **é«˜æ€§èƒ½**: æ˜¾è‘—ä¼˜äºæ ‡å‡†malloc/freeçš„åˆ†é…é€Ÿåº¦
2. **å†…å­˜æ•ˆç‡**: å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å†…å­˜åˆ©ç”¨ç‡
3. **LevelDBå…¼å®¹**: åŸºäºLevelDB Arenaè®¾è®¡ç†å¿µ
4. **çº¿ç¨‹å®‰å…¨**: æ”¯æŒå•çº¿ç¨‹é«˜æ€§èƒ½æ“ä½œ
5. **æ˜“ç”¨æ€§**: æä¾›ç®€æ´çš„APIæ¥å£

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### æ•°æ®ç»“æ„è®¾è®¡

```c
typedef struct kv_arena {
    char *alloc_ptr;         // å½“å‰åˆ†é…æŒ‡é’ˆ
    size_t alloc_bytes_remaining; // å½“å‰å—å‰©ä½™å­—èŠ‚æ•°
    
    // åˆ†é…çš„å†…å­˜å—é“¾è¡¨
    struct arena_block {
        char *data;
        size_t size;
        struct arena_block *next;
    } *blocks;
    
    // ç»Ÿè®¡ä¿¡æ¯
    size_t total_allocated;  // æ€»åˆ†é…å­—èŠ‚æ•°
    size_t total_blocks;     // æ€»å—æ•°
    size_t memory_usage;     // å†…å­˜ä½¿ç”¨é‡
    
    // é…ç½®
    size_t block_size;       // å—å¤§å°
} kv_arena_t;
```

### æ ¸å¿ƒç®—æ³•

#### 1. æŒ‡é’ˆç¢°æ’åˆ†é… (Pointer Bumping)
- åœ¨å½“å‰å—ä¸­é€šè¿‡ç®€å•çš„æŒ‡é’ˆé€’å¢è¿›è¡Œåˆ†é…
- O(1)æ—¶é—´å¤æ‚åº¦ï¼Œæé«˜çš„åˆ†é…æ•ˆç‡
- å†…å­˜å¸ƒå±€ç´§å‡‘ï¼Œç¼“å­˜å‹å¥½

#### 2. å—ç®¡ç†ç­–ç•¥
- å½“å‰å—ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨åˆ†é…æ–°å—
- æ”¯æŒè¶…å¤§åˆ†é…è¯·æ±‚çš„ç‹¬ç«‹å—å¤„ç†
- å—é“¾è¡¨ç®¡ç†ï¼Œç»Ÿä¸€æ¸…ç†

#### 3. å†…å­˜å¯¹é½
- é»˜è®¤8å­—èŠ‚å¯¹é½ï¼Œç¡®ä¿æ€§èƒ½
- æ”¯æŒè‡ªå®šä¹‰å¯¹é½è¦æ±‚
- å¯¹é½è®¡ç®—ä¼˜åŒ–ï¼Œå‡å°‘å†…å­˜æµªè´¹

## ğŸ”§ æ ¸å¿ƒAPI

### ç”Ÿå‘½å‘¨æœŸç®¡ç†

```c
// åˆ›å»ºarenaå†…å­˜æ± 
kv_arena_t *kv_arena_create(size_t block_size);

// é”€æ¯arenaå†…å­˜æ± 
void kv_arena_destroy(kv_arena_t *arena);
```

### å†…å­˜åˆ†é…

```c
// åŸºç¡€å†…å­˜åˆ†é…
void *kv_arena_alloc(kv_arena_t *arena, size_t size);

// å¯¹é½å†…å­˜åˆ†é…
void *kv_arena_alloc_aligned(kv_arena_t *arena, size_t size, size_t alignment);
```

### ç»Ÿè®¡ä¿¡æ¯

```c
// è·å–å†…å­˜ä½¿ç”¨é‡
size_t kv_arena_memory_usage(const kv_arena_t *arena);

// è·å–æ€»åˆ†é…é‡
size_t kv_arena_total_allocated(const kv_arena_t *arena);
```

## ğŸ“Š æ€§èƒ½ç‰¹å¾

### åŸºå‡†æµ‹è¯•ç»“æœ

åŸºäº100,000æ¬¡64å­—èŠ‚åˆ†é…çš„æµ‹è¯•ï¼š

| æŒ‡æ ‡ | Arena | æ ‡å‡†malloc | æ€§èƒ½æå‡ |
|------|-------|------------|----------|
| åˆ†é…æ—¶é—´ | 682Î¼s | 4033Î¼s | **5.91x** |
| å†…å­˜æ•ˆç‡ | 99.61% | ~85% | **+14.61%** |
| å†…å­˜ä½¿ç”¨ | 6.42MB | 6.40MB | æä½å¼€é”€ |

### é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**:
- æ‰¹é‡åˆ†é…ç›¸åŒæˆ–ç›¸ä¼¼å¤§å°çš„å¯¹è±¡
- å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç›¸åŒæˆ–ç›¸è¿‘
- é«˜é¢‘ç‡çš„å†…å­˜åˆ†é…/é‡Šæ”¾æ“ä½œ
- å†…å­˜ä½¿ç”¨æ¨¡å¼å¯é¢„æµ‹

âŒ **ä¸æ¨èä½¿ç”¨**:
- éœ€è¦å•ç‹¬é‡Šæ”¾å¯¹è±¡çš„åœºæ™¯
- å¯¹è±¡å¤§å°å·®å¼‚æå¤§
- é•¿æœŸæŒæœ‰çš„å°å¯¹è±¡
- å¤šçº¿ç¨‹å¹¶å‘è®¿é—®

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

å®Œæ•´çš„æµ‹è¯•å¥—ä»¶åŒ…å«53é¡¹æµ‹è¯•ï¼Œ100%é€šè¿‡ç‡ï¼š

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•** (13é¡¹)
   - Arenaåˆ›å»ºå’Œé”€æ¯
   - åŸºç¡€å†…å­˜åˆ†é…
   - å¤§å—å†…å­˜åˆ†é…

2. **é«˜çº§åŠŸèƒ½æµ‹è¯•** (16é¡¹)
   - å†…å­˜å¯¹é½åˆ†é…
   - ç»Ÿè®¡ä¿¡æ¯åŠŸèƒ½
   - å¤šå—åˆ†é…ç®¡ç†

3. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•** (10é¡¹)
   - NULLæŒ‡é’ˆå¤„ç†
   - æå¤§åˆ†é…è¯·æ±‚
   - è¿ç»­å°åˆ†é…

4. **æ€§èƒ½æµ‹è¯•** (6é¡¹)
   - åˆ†é…æ€§èƒ½å¯¹æ¯”
   - å†…å­˜æ•ˆç‡æµ‹è¯•
   - ç»Ÿè®¡ä¿¡æ¯éªŒè¯

5. **å…¼å®¹æ€§æµ‹è¯•** (8é¡¹)
   - æ ‡å‡†APIå…¼å®¹æ€§
   - å®å®šä¹‰æµ‹è¯•
   - æ¸…ç†å‡½æ•°æµ‹è¯•

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
cd ConcordKV/tests/kvserver_tests/memory_tests
make benchmark
```

## ğŸ” å®ç°ç»†èŠ‚

### å†…å­˜å¯¹é½ç®—æ³•

```c
static size_t align_size(size_t size, size_t alignment) {
    return (size + alignment - 1) & ~(alignment - 1);
}
```

### å—åˆ†é…ç­–ç•¥

1. **å°åˆ†é…**: åœ¨å½“å‰å—ä¸­åˆ†é…
2. **å¤§åˆ†é…**: åˆ›å»ºç‹¬ç«‹å—
3. **å—å¤§å°**: é»˜è®¤4KBï¼Œå¯é…ç½®
4. **é“¾è¡¨ç®¡ç†**: æ–°å—æ’å…¥å¤´éƒ¨

### ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

- **å®æ—¶ç»Ÿè®¡**: æ¯æ¬¡åˆ†é…æ›´æ–°ç»Ÿè®¡
- **å†…å­˜ä½¿ç”¨**: åŒ…å«ç»“æ„ä½“å¼€é”€
- **åˆ†é…æ€»é‡**: å¯¹é½åçš„å®é™…åˆ†é…é‡

## ğŸ“ˆ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```c
#include "kv_memory.h"

// åˆ›å»ºarena
kv_arena_t *arena = kv_arena_create(8192);

// åˆ†é…å†…å­˜
void *ptr1 = kv_arena_alloc(arena, 256);
void *ptr2 = kv_arena_alloc(arena, 512);

// å¯¹é½åˆ†é…
void *aligned_ptr = kv_arena_alloc_aligned(arena, 100, 16);

// è·å–ç»Ÿè®¡ä¿¡æ¯
size_t usage = kv_arena_memory_usage(arena);
size_t allocated = kv_arena_total_allocated(arena);

// æ¸…ç†
kv_arena_destroy(arena);
```

### å®é™…åº”ç”¨åœºæ™¯

```c
// KVå­˜å‚¨ç¤ºä¾‹
typedef struct {
    char *key;
    char *value;
} kv_pair_t;

kv_arena_t *arena = kv_arena_create(16384);

// æ‰¹é‡åˆ†é…é”®å€¼å¯¹
kv_pair_t *pairs = kv_arena_alloc(arena, 100 * sizeof(kv_pair_t));

for (int i = 0; i < 100; i++) {
    // åˆ†é…é”®å’Œå€¼çš„å­˜å‚¨ç©ºé—´
    pairs[i].key = kv_arena_alloc(arena, key_size);
    pairs[i].value = kv_arena_alloc(arena, value_size);
}

// ç»Ÿä¸€æ¸…ç†ï¼Œæ— éœ€é€ä¸ªé‡Šæ”¾
kv_arena_destroy(arena);
```

## ğŸ”§ æ„å»ºå’Œæµ‹è¯•

### ç¼–è¯‘æµ‹è¯•

```bash
# ç¼–è¯‘æµ‹è¯•ç¨‹åº
cd ConcordKV/tests/kvserver_tests/memory_tests
make all

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
make benchmark

# å†…å­˜æ³„æ¼æ£€æµ‹
make valgrind
```

### ç¼–è¯‘æ¼”ç¤ºç¨‹åº

```bash
# ç¼–è¯‘æ¼”ç¤ºç¨‹åº
cd ConcordKV/examples
make -f Makefile.arena_demo all

# è¿è¡Œæ¼”ç¤º
make -f Makefile.arena_demo run
```

## ğŸš€ æŠ€æœ¯ä¼˜åŠ¿

### 1. é«˜æ€§èƒ½åˆ†é…

- **æŒ‡é’ˆç¢°æ’**: O(1)åˆ†é…æ—¶é—´
- **æ‰¹é‡åˆ†é…**: å‡å°‘ç³»ç»Ÿè°ƒç”¨
- **å†…å­˜å±€éƒ¨æ€§**: è¿ç»­åˆ†é…æå‡ç¼“å­˜å‘½ä¸­ç‡

### 2. å†…å­˜é«˜æ•ˆ

- **ä½ç¢ç‰‡**: é¡ºåºåˆ†é…å‡å°‘å¤–éƒ¨ç¢ç‰‡
- **é«˜åˆ©ç”¨ç‡**: 99%+çš„å†…å­˜åˆ©ç”¨æ•ˆç‡
- **æ‰¹é‡é‡Šæ”¾**: ä¸€æ¬¡æ€§é‡Šæ”¾æ‰€æœ‰å†…å­˜

### 3. LevelDBå…¼å®¹

- **è®¾è®¡ç†å¿µ**: åŸºäºLevelDB Arenaè®¾è®¡
- **ç®—æ³•ä¼˜åŒ–**: é‡‡ç”¨æˆç†Ÿçš„åˆ†é…ç­–ç•¥
- **ç”Ÿäº§éªŒè¯**: ç»è¿‡å¤§è§„æ¨¡ç³»ç»ŸéªŒè¯



## ğŸ”— å‚è€ƒèµ„æ–™

1. [LevelDB Arenaå®ç°](https://github.com/google/leveldb/blob/main/util/arena.h)
2. [Google C++ Style Guide](https://google.github.io/styleguide/cppguide.html)
3. [Memory Pool Design Patterns](https://en.wikipedia.org/wiki/Memory_pool)

