# ConcordKV å®Œæ•´å¸ƒéš†è¿‡æ»¤å™¨æ¼”ç¤ºç¨‹åº Makefile
# Author: Lzww0608
# Date: 2025-6-6 18:45:00

CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -O2 -g
INCLUDES = -I../../kvserver -I../../
LIBS = -lm -lpthread -lrt

# æºæ–‡ä»¶
DEMO_SRC = bloom_filter_complete_demo.c
BLOOM_SRC = ../../kvserver/lsm_bloom_filter_optimized.c
SOURCES = $(DEMO_SRC) $(BLOOM_SRC)

# ç›®æ ‡æ–‡ä»¶
TARGET = bloom_filter_complete_demo
OBJECTS = $(SOURCES:.c=.o)

# é»˜è®¤ç›®æ ‡
all: $(TARGET)

# ç¼–è¯‘æ¼”ç¤ºç¨‹åº
$(TARGET): $(OBJECTS)
	@echo "ğŸ”§ é“¾æ¥å¸ƒéš†è¿‡æ»¤å™¨å®Œæ•´æ¼”ç¤ºç¨‹åº..."
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $@"

# ç¼–è¯‘æºæ–‡ä»¶
%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# è¿è¡Œæ¼”ç¤ºç¨‹åº
run: $(TARGET)
	@echo "ğŸš€ è¿è¡Œå¸ƒéš†è¿‡æ»¤å™¨å®Œæ•´æ¼”ç¤º..."
	./$(TARGET)

# æ€§èƒ½æµ‹è¯•
benchmark: $(TARGET)
	@echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	./$(TARGET) | grep -A 20 "æ€§èƒ½å¯¹æ¯”æµ‹è¯•"

# å†…å­˜æ£€æŸ¥
valgrind: $(TARGET)
	@echo "ğŸ” å†…å­˜æ³„æ¼æ£€æŸ¥..."
	valgrind --leak-check=full --show-leak-kinds=all ./$(TARGET)

# è°ƒè¯•æ¨¡å¼ç¼–è¯‘
debug: CFLAGS += -DDEBUG -O0 -g3
debug: clean $(TARGET)
	@echo "ğŸ› è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# å‘å¸ƒæ¨¡å¼ç¼–è¯‘
release: CFLAGS += -DNDEBUG -O3 -march=native -flto
release: clean $(TARGET)
	@echo "ğŸš€ å‘å¸ƒç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# åˆ†æç¼–è¯‘å™¨ä¼˜åŒ–
analyze: CFLAGS += -fopt-info-vec -fopt-info-loop
analyze: clean $(TARGET)
	@echo "ğŸ“Š ç¼–è¯‘å™¨ä¼˜åŒ–åˆ†æå®Œæˆ"

# ä»£ç è¦†ç›–ç‡
coverage: CFLAGS += --coverage
coverage: LIBS += --coverage
coverage: clean $(TARGET)
	@echo "ğŸ“ˆ è¦†ç›–ç‡ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"
	./$(TARGET)
	gcov $(SOURCES)
	@echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

# é™æ€åˆ†æ
static-analysis:
	@echo "ğŸ” è¿è¡Œé™æ€ä»£ç åˆ†æ..."
	cppcheck --enable=all --std=c99 $(SOURCES)
	@echo "âœ… é™æ€åˆ†æå®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	clang-format -i $(SOURCES) *.h
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(TARGET) $(OBJECTS) *.gcov *.gcda *.gcno
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ¯ ConcordKV å¸ƒéš†è¿‡æ»¤å™¨å®Œæ•´æ¼”ç¤ºç¨‹åº"
	@echo "========================================="
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ¼”ç¤ºç¨‹åº (é»˜è®¤)"
	@echo "  run           - è¿è¡Œæ¼”ç¤ºç¨‹åº"
	@echo "  benchmark     - è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  valgrind      - å†…å­˜æ³„æ¼æ£€æŸ¥"
	@echo "  debug         - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  release       - ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬"
	@echo "  analyze       - ç¼–è¯‘å™¨ä¼˜åŒ–åˆ†æ"
	@echo "  coverage      - ä»£ç è¦†ç›–ç‡åˆ†æ"
	@echo "  static-analysis - é™æ€ä»£ç åˆ†æ"
	@echo "  format        - æ ¼å¼åŒ–ä»£ç "
	@echo "  clean         - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# å®‰è£…ä¾èµ– (Ubuntu/Debian)
install-deps:
	@echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
	sudo apt-get update
	sudo apt-get install -y gcc make valgrind cppcheck clang-format gcov
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# åˆ›å»ºæ¼”ç¤ºæ•°æ®
demo-data:
	@echo "ğŸ“Š åˆ›å»ºæ¼”ç¤ºæ•°æ®æ–‡ä»¶..."
	mkdir -p data
	echo "ConcordKV å¸ƒéš†è¿‡æ»¤å™¨æµ‹è¯•æ•°æ®" > data/test_data.txt
	for i in {1..10000}; do echo "test_key_$$i" >> data/test_data.txt; done
	@echo "âœ… æ¼”ç¤ºæ•°æ®åˆ›å»ºå®Œæˆ: data/test_data.txt"

# ç³»ç»Ÿä¿¡æ¯
system-info:
	@echo "ğŸ’» ç³»ç»Ÿä¿¡æ¯:"
	@echo "  æ“ä½œç³»ç»Ÿ: $$(uname -s)"
	@echo "  æ¶æ„: $$(uname -m)"
	@echo "  å†…æ ¸ç‰ˆæœ¬: $$(uname -r)"
	@echo "  ç¼–è¯‘å™¨ç‰ˆæœ¬: $$($(CC) --version | head -1)"
	@echo "  CPUä¿¡æ¯: $$(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)"
	@echo "  å†…å­˜ä¿¡æ¯: $$(free -h | grep 'Mem:' | awk '{print $$2}')"

.PHONY: all run benchmark valgrind debug release analyze coverage static-analysis format clean help install-deps demo-data system-info 