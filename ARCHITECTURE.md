# ConcordKV 系统架构文档

## 1. 系统概述

ConcordKV 是一个基于 Raft 协议的分布式键值存储系统，旨在提供高可用性、强一致性和良好的扩展性。系统由 C/C++ 实现的存储引擎和计划用 Go 实现的分布式协调层组成。

## 2. 核心组件

### 2.1 存储引擎 (C/C++)

存储引擎位于 `kvserver` 目录，负责数据的本地存储、检索和管理。它提供以下核心功能：

- **多种数据结构**：支持数组、红黑树、哈希表等多种数据结构。
- **持久化**：通过预写日志(WAL)和快照机制确保数据持久化。
- **并发控制**：提供多级锁机制，包括读写锁、自旋锁和分段锁。
- **事务支持**：实现 ACID 特性和多种隔离级别。
- **快照和恢复**：支持数据状态快照和从快照恢复。
- **错误处理**：统一的错误处理和日志记录系统。

### 2.2 分布式协调层 (Go)

分布式协调层位于 `raftserver` 目录，负责节点间通信、共识和集群管理。主要功能包括：

- **Raft 协议实现**：选举、日志复制和成员变更。
- **集群管理**：节点发现、健康检查和负载均衡。
- **分片管理**：数据分片和路由。
- **客户端接口**：提供 API 供客户端访问。

### 2.3 客户端库 (Go/C++)

客户端库位于 `client` 目录，为应用程序提供访问 ConcordKV 的接口。

### 2.4 通用工具和配置

位于 `common` 目录，包含通用工具、配置管理和测试框架。

## 3. 模块交互关系

```
+----------------+     +------------------+     +----------------+
|                |     |                  |     |                |
|    Client      +---->+  Raft Server     +---->+  KV Server     |
|   (Go/C++)     |     |     (Go)         |     |    (C/C++)     |
|                |     |                  |     |                |
+----------------+     +------------------+     +----------------+
                              |
                              v
                       +----------------+
                       |                |
                       |    Common      |
                       |                |
                       +----------------+
```

### 核心交互流程：

1. **客户端请求处理**：
   - 客户端发送请求到 Raft 服务器
   - Raft 服务器将请求通过共识算法复制到集群
   - 请求提交后转发到 KV 存储引擎执行
   - 结果返回给客户端

2. **集群状态管理**：
   - Raft 服务器负责维护集群成员状态
   - 处理节点加入、离开和故障
   - 进行领导者选举和日志复制

3. **数据分片和路由**：
   - 根据键的哈希值确定数据分片
   - 将请求路由到对应分片的负责节点
   - 维护分片分布和副本状态

## 4. 存储引擎详细设计

### 4.1 模块交互图

```
+----------------+     +------------------+     +----------------+
|                |     |                  |     |                |
| KV Transaction +---->+ KV Concurrency   +---->+ KV Store      |
|                |     |                  |     | (数据结构实现) |
+----------------+     +------------------+     +----------------+
        |                      |                       |
        v                      v                       v
+----------------+     +------------------+     +----------------+
|                |     |                  |     |                |
|  KV Persist    +---->+   KV Snapshot    +---->+   KV Error    |
|                |     |                  |     |                |
+----------------+     +------------------+     +----------------+
                              |
                              v
                       +----------------+
                       |                |
                       |  KV Cluster    |
                       |                |
                       +----------------+
```

### 4.2 主要模块功能：

- **kv_store**：核心存储接口，支持多种数据结构实现
- **kv_persist**：数据持久化，WAL 日志管理
- **kv_concurrency**：并发控制，多级锁机制
- **kv_transaction**：事务管理，支持 ACID 特性
- **kv_cluster**：集群管理，节点通信与协调
- **kv_snapshot**：数据快照创建与恢复
- **kv_error**：统一的错误处理与日志机制

## 5. 分布式协调层详细设计

### 5.1 模块组成：

- **raft**：Raft 共识算法核心实现
- **transport**：节点间通信机制
- **storage**：Raft 日志和状态存储
- **server**：服务器和请求处理
- **api**：客户端 API 和接口定义

## 6. 技术特性

- **强一致性**：通过 Raft 协议确保数据一致性
- **高可用性**：支持自动故障转移和数据复制
- **水平扩展**：通过分片机制支持集群扩展
- **事务支持**：提供完整的 ACID 事务支持
- **可靠性**：通过 WAL 和快照机制确保数据可靠性

## 7. 部署架构

ConcordKV 支持多种部署模式：

- **单节点模式**：适用于开发和测试
- **集群模式**：提供高可用性和扩展性
- **多数据中心模式**：支持跨地域部署 