# ConcordKV åˆ†ç‰‡ç®¡ç†é›†æˆ Makefile
# @Author: Lzww0608
# @Date: 2025-01-08 20:50:00
# å¤ç”¨ç°æœ‰å­˜å‚¨å¼•æ“å®ç°

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -pthread -fPIC -O2 -D_GNU_SOURCE
INCLUDES = -I.. -I../../common/util -I../../common/config
LIBS = -lm -lpthread

# è°ƒè¯•æ¨¡å¼é…ç½®
DEBUG_CFLAGS = -g -DDEBUG -O0
RELEASE_CFLAGS = -O3 -DNDEBUG

# æºæ–‡ä»¶ (ç§»é™¤mockæ–‡ä»¶)
SHARD_SOURCES = shard_hash.c shard_config.c shard_aware_engine.c
SHARD_OBJECTS = $(SHARD_SOURCES:.c=.o)

# ç°æœ‰kvserveræ ¸å¿ƒæºæ–‡ä»¶ (åŒ…å«metrics mocké¿å…é“¾æ¥é—®é¢˜)
KVSERVER_DIR = ..
KVSERVER_SOURCES = \
	$(KVSERVER_DIR)/kv_engine_factory.c \
	$(KVSERVER_DIR)/kv_engine_config.c \
	$(KVSERVER_DIR)/kv_memory.c \
	$(KVSERVER_DIR)/kvstore.c \
	$(KVSERVER_DIR)/kvstore_array.c \
	$(KVSERVER_DIR)/kvstore_hash.c \
	$(KVSERVER_DIR)/kvstore_btree.c \
	$(KVSERVER_DIR)/kvstore_rbtree.c \
	$(KVSERVER_DIR)/rbtree_adapter.c \
	$(KVSERVER_DIR)/btree_adapter.c \
	$(KVSERVER_DIR)/kv_error.c \
	kv_engine_metrics_mock.c

KVSERVER_OBJECTS = $(KVSERVER_SOURCES:.c=.o)

# æµ‹è¯•æ–‡ä»¶
TEST_SOURCES = tests/test_shard_integration.c
TEST_OBJECTS = $(TEST_SOURCES:.c=.o)

# ç›®æ ‡åº“å’Œå¯æ‰§è¡Œæ–‡ä»¶
SHARD_LIB = libshard.a
KVSERVER_LIB = libkvserver.a
TEST_EXEC = test_shard_integration

# ä¾èµ–æ¨¡å—
COMMON_CONFIG_DIR = ../../common/config
CONFIG_SOURCES = $(COMMON_CONFIG_DIR)/config.c $(COMMON_CONFIG_DIR)/parser.c
CONFIG_OBJECTS = $(CONFIG_SOURCES:.c=.o)

# æ‰©å±•kvserverä¾èµ–æºæ–‡ä»¶
EXTENDED_KVSERVER_SOURCES = \
	../kv_engine_factory.c \
	../kv_engine_config.c \
	../kv_memory.c \
	../kv_error.c \
	../kvstore_array.c \
	../kvstore_hash.c \
	../kvstore_btree.c \
	../kvstore_rbtree.c \
	../rbtree_adapter.c \
	../btree_adapter.c

EXTENDED_KVSERVER_OBJECTS = $(EXTENDED_KVSERVER_SOURCES:.c=.o)

# é»˜è®¤ç›®æ ‡
all: $(SHARD_LIB) $(KVSERVER_LIB)

# åˆ†ç‰‡ç®¡ç†åº“
$(SHARD_LIB): $(SHARD_OBJECTS)
	@echo "ğŸ“¦ Creating shard management library..."
	ar rcs $@ $^
	@echo "âœ… Library created: $@"

# kvserveråº“
$(KVSERVER_LIB): $(KVSERVER_OBJECTS)
	@echo "ğŸ“¦ Creating kvserver library..."
	ar rcs $@ $^
	@echo "âœ… Library created: $@"

# ç¼–è¯‘åˆ†ç‰‡ç®¡ç†æºæ–‡ä»¶
%.o: %.c
	@echo "ğŸ”¨ Compiling $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ç¼–è¯‘kvserveræºæ–‡ä»¶
$(KVSERVER_DIR)/%.o: $(KVSERVER_DIR)/%.c
	@echo "ğŸ”¨ Compiling $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ç®€åŒ–æµ‹è¯•
simple_test: simple_test_exec
	@echo "ğŸ§ª Running simple tests..."
	./simple_test

simple_test_exec: tests/simple_test.o $(SHARD_LIB) $(EXTENDED_KVSERVER_OBJECTS) $(CONFIG_OBJECTS) kv_engine_metrics_mock.o
	@echo "ğŸ§ª Building simple test executable..."
	$(CC) $(CFLAGS) $(DEBUG_CFLAGS) $(INCLUDES) -o simple_test $^ $(LIBS)
	@echo "âœ… Simple test executable created: simple_test"

tests/simple_test.o: tests/simple_test.c
	@echo "ğŸ”¨ Compiling tests/simple_test.c..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# æµ‹è¯•ç›®æ ‡
test: $(TEST_EXEC)
	@echo "ğŸ§ª Running integration tests..."
	./$(TEST_EXEC)

# æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
$(TEST_EXEC): $(TEST_OBJECTS) $(SHARD_LIB) $(KVSERVER_LIB)
	@echo "ğŸ§ª Building test executable..."
	$(CC) $(CFLAGS) $(DEBUG_CFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "âœ… Test executable created: $@"

# è°ƒè¯•ç‰ˆæœ¬
debug: CFLAGS += $(DEBUG_CFLAGS)
debug: all

# å‘å¸ƒç‰ˆæœ¬
release: CFLAGS += $(RELEASE_CFLAGS)
release: all

# è¯­æ³•æ£€æŸ¥
lint:
	@echo "ğŸ“ Running syntax check..."
	$(CC) $(CFLAGS) $(INCLUDES) -fsyntax-only $(SHARD_SOURCES)
	@echo "âœ… Syntax check passed"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -f $(SHARD_OBJECTS) $(KVSERVER_OBJECTS) $(TEST_OBJECTS) $(SHARD_LIB) $(KVSERVER_LIB) $(TEST_EXEC)
	@echo "âœ… Cleanup completed"

# ä»£ç ç»Ÿè®¡
stats:
	@echo "ğŸ“Š Code statistics:"
	@echo "   ğŸ“„ Source files: $(words $(SHARD_SOURCES))"
	@echo "   ğŸ“ Lines of code:"
	@wc -l $(SHARD_SOURCES) $(wildcard *.h) | tail -1
	@echo "   ğŸ“¦ Object files: $(words $(SHARD_OBJECTS))"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸš€ ConcordKV Sharding Management Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  all       - Build all libraries (default)"
	@echo "  test      - Build and run tests"
	@echo "  debug     - Build with debug symbols"
	@echo "  release   - Build optimized release version"
	@echo "  lint      - Run syntax check"
	@echo "  clean     - Clean build artifacts"
	@echo "  stats     - Show code statistics"
	@echo "  help      - Show this help message"

# ä¼ªç›®æ ‡
.PHONY: all test debug release lint clean stats help

# ä¾èµ–å…³ç³»
shard_hash.o: shard_hash.h
shard_config.o: shard_config.h shard_hash.h
shard_aware_engine.o: shard_aware_engine.h shard_config.h shard_hash.h
tests/test_shard_integration.o: shard_aware_engine.h shard_config.h shard_hash.h

# ç¼–è¯‘configæ¨¡å—
$(COMMON_CONFIG_DIR)/%.o: $(COMMON_CONFIG_DIR)/%.c
	@echo "ğŸ”¨ Compiling $<..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@
